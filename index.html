<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Banco de Horas - Firebase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
        }

        .sidebar h2 {
            padding: 0 20px;
            margin-bottom: 30px;
            font-size: 1.2rem;
            border-bottom: 1px solid #34495e;
            padding-bottom: 10px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .sidebar li:hover {
            background-color: #34495e;
        }

        .sidebar li.active {
            background-color: #3498db;
            border-left: 4px solid #2980b9;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            background-color: #f5f5f5;
        }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .card .subtitle {
            color: #7f8c8d;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .recent-activities {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .recent-activities h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        /* Forms and Tables */
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-info {
            background-color: #3498db;
            color: white;
        }

        .btn-info:hover {
            background-color: #2980b9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        table {
            width: 100%;
            background-color: white;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        th {
            background-color: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 0.9rem;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .status-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-inativo {
            color: #7f8c8d;
            font-style: italic;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .badge-ativo {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-inativo {
            background-color: #f8d7da;
            color: #721c24;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .template-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .template-box h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .template-example {
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
        }

        .copy-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 5px;
            margin-right: 5px;
        }

        .copy-btn:hover {
            background-color: #2980b9;
        }

        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-box input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .search-box select {
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 150px;
        }

        .pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .pagination button {
            padding: 5px 10px;
            border: 1px solid #bdc3c7;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        .pagination button:hover {
            background-color: #ecf0f1;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .empty-state button {
            margin-top: 15px;
        }

        .file-upload-area {
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .file-upload-area:hover {
            border-color: #3498db;
            background-color: #e8f4f8;
        }

        .file-upload-area.dragover {
            border-color: #27ae60;
            background-color: #d4edda;
        }

        .file-upload-area i {
            font-size: 48px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .file-upload-area p {
            color: #7f8c8d;
            margin: 5px 0;
        }

        .file-upload-area .file-name {
            font-weight: bold;
            color: #2c3e50;
            margin-top: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #27ae60;
            width: 0%;
            transition: width 0.3s;
            text-align: center;
            color: white;
            font-size: 12px;
            line-height: 20px;
        }

        .import-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .import-options button {
            flex: 1;
        }

        .validation-summary {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .validation-item {
            padding: 5px;
            border-bottom: 1px solid #ecf0f1;
        }

        .validation-item:last-child {
            border-bottom: none;
        }

        .validation-item.success {
            color: #27ae60;
        }

        .validation-item.error {
            color: #e74c3c;
        }

        .lancamento-filters {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .month-year-picker {
            display: flex;
            gap: 10px;
        }

        .month-year-picker select {
            flex: 1;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }

        .resumo-mensal {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .resumo-item {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .resumo-item .label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .resumo-item .value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .resumo-item.positivo .value {
            color: #27ae60;
        }

        .resumo-item.negativo .value {
            color: #e74c3c;
        }

        .resumo-item.saldo .value {
            color: #3498db;
        }

        .info-box {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Banco de Horas</h2>
            <ul>
                <li onclick="showTab('dashboard')">Dashboard</li>
                <li class="active" onclick="showTab('colaboradores')">Colaboradores</li>
                <li onclick="showTab('lancamentos')">Banco de Horas</li>
                <li onclick="showTab('configuracoes')">Configura√ß√µes</li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <h2>Dashboard</h2>
                <div class="dashboard">
                    <div class="card">
                        <h3>Total de Colaboradores</h3>
                        <div class="number" id="totalColaboradores">0</div>
                        <div class="subtitle">Ativos no sistema</div>
                    </div>
                    <div class="card">
                        <h3>Horas Positivas</h3>
                        <div class="number" id="totalHorasPositivas">0</div>
                        <div class="subtitle">Total de horas a compensar</div>
                    </div>
                    <div class="card">
                        <h3>Horas Negativas</h3>
                        <div class="number" id="totalHorasNegativas">0</div>
                        <div class="subtitle">Total de horas em d√©bito</div>
                    </div>
                    <div class="card">
                        <h3>Saldo L√≠quido</h3>
                        <div class="number" id="saldoLiquido">0</div>
                        <div class="subtitle">Positivo - Negativo</div>
                    </div>
                </div>

                <div class="recent-activities">
                    <h3>√öltimos Lan√ßamentos</h3>
                    <div id="recentActivities">
                        <!-- Atividades ser√£o inseridas aqui via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Colaboradores Tab -->
            <div id="colaboradores" class="tab-content">
                <div class="header-actions">
                    <h2>Colaboradores</h2>
                    <div>
                        <button class="btn btn-success" onclick="showImportModal()">Importar Planilha</button>
                        <button class="btn btn-primary" onclick="showColaboradorModal()">Novo Colaborador</button>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="searchColaborador" placeholder="Buscar por nome, departamento ou empresa..." onkeyup="filterColaboradores()">
                    <select id="filterStatus" onchange="filterColaboradores()">
                        <option value="ativos">Ativos</option>
                        <option value="todos">Todos</option>
                        <option value="inativos">Inativos</option>
                    </select>
                    <select id="filterDepartamento" onchange="filterColaboradores()">
                        <option value="">Todos Departamentos</option>
                    </select>
                    <select id="filterEmpresa" onchange="filterColaboradores()">
                        <option value="">Todas Empresas</option>
                    </select>
                </div>

                <div id="importAlert" class="alert hidden"></div>

                <table id="colaboradoresTable">
                    <thead>
                        <tr>
                            <th onclick="sortColaboradores('nome')" style="cursor: pointer;">Nome Completo üìä</th>
                            <th onclick="sortColaboradores('dataAdmissao')" style="cursor: pointer;">Data de Admiss√£o üìä</th>
                            <th onclick="sortColaboradores('departamento')" style="cursor: pointer;">Departamento üìä</th>
                            <th onclick="sortColaboradores('empresa')" style="cursor: pointer;">Empresa üìä</th>
                            <th>Saldo de Horas</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="colaboradoresList">
                        <!-- Colaboradores ser√£o inseridos aqui via JavaScript -->
                    </tbody>
                </table>

                <div class="pagination" id="pagination">
                    <!-- Pagina√ß√£o ser√° inserida aqui -->
                </div>
            </div>

            <!-- Banco de Horas / Lan√ßamentos Tab -->
            <div id="lancamentos" class="tab-content">
                <div class="header-actions">
                    <h2>Banco de Horas</h2>
                    <button class="btn btn-primary" onclick="showLancamentoModal()">Novo Lan√ßamento</button>
                </div>

                <!-- Filtros -->
                <div class="lancamento-filters">
                    <div class="filter-group">
                        <label>Selecione o Colaborador:</label>
                        <select id="filtroColaborador" onchange="filtrarLancamentos()">
                            <option value="">-- Selecione um colaborador --</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Per√≠odo (M√™s/Ano):</label>
                        <div class="month-year-picker">
                            <select id="filtroMes" onchange="filtrarLancamentos()">
                                <option value="01">Janeiro</option>
                                <option value="02">Fevereiro</option>
                                <option value="03">Mar√ßo</option>
                                <option value="04">Abril</option>
                                <option value="05">Maio</option>
                                <option value="06">Junho</option>
                                <option value="07">Julho</option>
                                <option value="08">Agosto</option>
                                <option value="09">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                            <select id="filtroAno" onchange="filtrarLancamentos()">
                                <!-- Anos ser√£o preenchidos via JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-info" onclick="limparFiltros()">Limpar Filtros</button>
                </div>

                <!-- Resumo do m√™s -->
                <div id="resumoMensal" class="resumo-mensal" style="display: none;">
                    <div class="resumo-item positivo">
                        <div class="label">Horas Positivas</div>
                        <div class="value" id="resumoPositivas">0</div>
                    </div>
                    <div class="resumo-item negativo">
                        <div class="label">Horas Negativas</div>
                        <div class="value" id="resumoNegativas">0</div>
                    </div>
                    <div class="resumo-item saldo">
                        <div class="label">Saldo do M√™s</div>
                        <div class="value" id="resumoSaldo">0</div>
                    </div>
                </div>

                <!-- Tabela de lan√ßamentos -->
                <div id="lancamentosContainer">
                    <div class="info-box" id="semSelecaoMsg">
                        üëÜ Selecione um colaborador e per√≠odo para visualizar os lan√ßamentos
                    </div>
                    <table id="lancamentosTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Descri√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lancamentosList">
                            <!-- Lan√ßamentos ser√£o inseridos aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Configura√ß√µes Tab -->
            <div id="configuracoes" class="tab-content">
                <h2>Configura√ß√µes</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- Empresas -->
                    <div class="card">
                        <div class="header-actions" style="margin-bottom: 15px;">
                            <h3>Empresas</h3>
                            <button class="btn btn-primary" onclick="showEmpresaModal()">Nova Empresa</button>
                        </div>
                        <div id="empresasAlert" class="alert alert-info hidden">Nenhuma empresa cadastrada. Clique em "Nova Empresa" para come√ßar.</div>
                        <table id="empresasTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="empresasList">
                                <!-- Empresas ser√£o inseridas aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Departamentos -->
                    <div class="card">
                        <div class="header-actions" style="margin-bottom: 15px;">
                            <h3>Departamentos</h3>
                            <button class="btn btn-primary" onclick="showDepartamentoModal()">Novo Departamento</button>
                        </div>
                        <div id="departamentosAlert" class="alert alert-info hidden">Nenhum departamento cadastrado. Clique em "Novo Departamento" para come√ßar.</div>
                        <table id="departamentosTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="departamentosList">
                                <!-- Departamentos ser√£o inseridos aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Colaborador -->
    <div id="colaboradorModal" class="modal">
        <div class="modal-content">
            <h3 id="colaboradorModalTitle">Novo Colaborador</h3>
            <form id="colaboradorForm" onsubmit="event.preventDefault(); saveColaborador();">
                <input type="hidden" id="colaboradorId">
                <div class="form-group">
                    <label>Nome Completo:</label>
                    <input type="text" id="colaboradorNome" required>
                </div>
                <div class="form-group">
                    <label>Data de Admiss√£o:</label>
                    <input type="text" id="colaboradorData" placeholder="DD/MM/AAAA" required>
                </div>
                <div class="form-group">
                    <label>Departamento:</label>
                    <select id="colaboradorDepartamento" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Empresa:</label>
                    <select id="colaboradorEmpresa" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="colaboradorAtivo" checked>
                    <label for="colaboradorAtivo">Colaborador Ativo</label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="hideModal('colaboradorModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Lan√ßamento -->
    <div id="lancamentoModal" class="modal">
        <div class="modal-content">
            <h3>Novo Lan√ßamento de Horas</h3>
            <form id="lancamentoForm" onsubmit="event.preventDefault(); saveLancamento();">
                <div class="form-group">
                    <label>Colaborador:</label>
                    <select id="lancamentoColaborador" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>M√™s/Ano:</label>
                    <div class="month-year-picker">
                        <select id="lancamentoMes" required>
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Mar√ßo</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                        <select id="lancamentoAno" required>
                            <!-- Anos ser√£o preenchidos via JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tipo:</label>
                    <select id="lancamentoTipo" required>
                        <option value="positiva">Hora Positiva (Extras)</option>
                        <option value="negativa">Hora Negativa (D√©bitos)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantidade de Horas:</label>
                    <input type="number" id="lancamentoHoras" step="0.5" min="0" required>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o:</label>
                    <textarea id="lancamentoDescricao" rows="3" placeholder="Motivo do lan√ßamento..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="hideModal('lancamentoModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Empresa -->
    <div id="empresaModal" class="modal">
        <div class="modal-content">
            <h3 id="empresaModalTitle">Nova Empresa</h3>
            <form id="empresaForm" onsubmit="event.preventDefault(); saveEmpresa();">
                <input type="hidden" id="empresaId">
                <input type="hidden" id="empresaNomeOriginal">
                <div class="form-group">
                    <label>Nome da Empresa:</label>
                    <input type="text" id="empresaNome" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="hideModal('empresaModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Departamento -->
    <div id="departamentoModal" class="modal">
        <div class="modal-content">
            <h3 id="departamentoModalTitle">Novo Departamento</h3>
            <form id="departamentoForm" onsubmit="event.preventDefault(); saveDepartamento();">
                <input type="hidden" id="departamentoId">
                <input type="hidden" id="departamentoNomeOriginal">
                <div class="form-group">
                    <label>Nome do Departamento:</label>
                    <input type="text" id="departamentoNome" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="hideModal('departamentoModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Importa√ß√£o -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <h3>Importar Planilha de Colaboradores</h3>
            
            <div class="template-box">
                <h4>üìã Modelo da Planilha</h4>
                <p>Formato: <strong>Nome, Data de Admiss√£o (DD/MM/AAAA), Departamento, Empresa</strong></p>
                
                <div class="template-example" id="templateText">
Jo√£o Silva,01/01/2023,TI,Empresa A
Maria Santos,15/03/2023,RH,Empresa B
Pedro Oliveira,10/02/2023,Financeiro,Empresa A
                </div>
                
                <button class="copy-btn" onclick="copyTemplate()">üìã Copiar Modelo</button>
                <button class="copy-btn" onclick="downloadTemplate()">üì• Baixar Modelo CSV</button>
                <p style="margin-top: 10px; font-size: 0.8rem; color: #e74c3c;">
                    ‚ö†Ô∏è Importante: Os departamentos e empresas usados na planilha precisam estar cadastrados primeiro!
                </p>
            </div>

            <!-- √Årea de upload de arquivo -->
            <div class="import-options">
                <button class="btn btn-info" onclick="showTextImport()">Importar como Texto</button>
                <button class="btn btn-success" onclick="showFileImport()">Importar Arquivo</button>
            </div>

            <!-- Importa√ß√£o por texto -->
            <div id="textImportSection" style="display: none;">
                <form id="importForm" onsubmit="event.preventDefault(); importColaboradores();">
                    <div class="form-group">
                        <label>Cole os dados da planilha:</label>
                        <textarea id="importData" rows="6" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px;" placeholder="Cole aqui os dados no formato do modelo acima..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-danger" onclick="hideModal('importModal')">Cancelar</button>
                        <button type="submit" class="btn btn-success">Importar</button>
                    </div>
                </form>
            </div>

            <!-- Importa√ß√£o por arquivo -->
            <div id="fileImportSection">
                <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                    <p><strong>Clique para selecionar</strong> ou arraste o arquivo aqui</p>
                    <p style="font-size: 0.8rem;">Formatos aceitos: CSV, XLS, XLSX, TXT</p>
                    <div id="fileName" class="file-name"></div>
                </div>
                
                <input type="file" id="fileInput" accept=".csv,.xls,.xlsx,.txt" style="display: none;" onchange="handleFileSelect(event)">

                <div class="progress-bar" id="progressBar">
                    <div class="progress-bar-fill" id="progressBarFill">0%</div>
                </div>

                <div id="validationSummary" class="validation-summary" style="display: none;">
                    <!-- Resultados da valida√ß√£o ser√£o inseridos aqui -->
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="hideModal('importModal')">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="processFileImport()" id="importButton" disabled>Importar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- Bibliotecas para leitura de arquivos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDY6qtn4JJPXggiswJjUZCt866oycv_LHk",
            authDomain: "gestao-de-banco-de-horas.firebaseapp.com",
            projectId: "gestao-de-banco-de-horas",
            storageBucket: "gestao-de-banco-de-horas.firebasestorage.app",
            messagingSenderId: "1071713106694",
            appId: "1:1071713106694:web:0a164293419ba46b6e7c87"
        };

        // Initialize Firebase
        let app;
        let db;
        let firebaseConnected = false;

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            // Configurar Firestore para usar timestamps
            const settings = { timestampsInSnapshots: true };
            db.settings(settings);
            
            // Testar conex√£o
            db.collection('test').limit(1).get()
                .then(() => {
                    firebaseConnected = true;
                    loadData(); // Carregar dados ap√≥s conectar
                })
                .catch((error) => {
                    console.error('Erro ao testar conex√£o:', error);
                    firebaseConnected = false;
                });
        } catch (error) {
            console.error('Erro ao inicializar Firebase:', error);
            firebaseConnected = false;
        }

        // Vari√°veis globais
        let colaboradores = [];
        let lancamentos = [];
        let empresas = [];
        let empresasDocs = [];
        let departamentos = [];
        let departamentosDocs = [];
        
        // Vari√°veis para importa√ß√£o
        let importedData = [];
        let importValidation = [];
        
        // Vari√°veis para filtros e pagina√ß√£o
        let colaboradoresFiltrados = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let sortField = 'nome';
        let sortDirection = 'asc';

        // Preencher anos nos selects
        function preencherAnos() {
            const anoAtual = new Date().getFullYear();
            const anos = [];
            for (let i = anoAtual - 5; i <= anoAtual + 1; i++) {
                anos.push(i);
            }
            
            const selects = ['filtroAno', 'lancamentoAno'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '';
                    anos.forEach(ano => {
                        const option = document.createElement('option');
                        option.value = ano;
                        option.textContent = ano;
                        if (ano === anoAtual) option.selected = true;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Fun√ß√£o para mostrar/esconder loading
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Fun√ß√£o para mostrar tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.sidebar li').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (tabName === 'lancamentos') {
                atualizarSelectColaboradores();
            }
        }

        // Fun√ß√µes para modais
        function showColaboradorModal(editId = null) {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }
            
            if (empresas.length === 0) {
                alert('Cadastre pelo menos uma empresa antes de adicionar colaboradores!');
                showTab('configuracoes');
                return;
            }
            
            if (departamentos.length === 0) {
                alert('Cadastre pelo menos um departamento antes de adicionar colaboradores!');
                showTab('configuracoes');
                return;
            }
            
            loadSelects();
            document.getElementById('colaboradorModal').style.display = 'block';
            if (editId) {
                document.getElementById('colaboradorModalTitle').textContent = 'Editar Colaborador';
                const colab = colaboradores.find(c => c.id === editId);
                if (colab) {
                    document.getElementById('colaboradorId').value = colab.id;
                    document.getElementById('colaboradorNome').value = colab.nome;
                    document.getElementById('colaboradorData').value = colab.dataAdmissao;
                    document.getElementById('colaboradorDepartamento').value = colab.departamento;
                    document.getElementById('colaboradorEmpresa').value = colab.empresa;
                    document.getElementById('colaboradorAtivo').checked = colab.ativo !== false;
                }
            } else {
                document.getElementById('colaboradorModalTitle').textContent = 'Novo Colaborador';
                document.getElementById('colaboradorId').value = '';
                document.getElementById('colaboradorForm').reset();
                document.getElementById('colaboradorAtivo').checked = true;
            }
        }

        function showLancamentoModal() {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }
            if (colaboradores.length === 0) {
                alert('Cadastre pelo menos um colaborador antes de fazer lan√ßamentos!');
                showTab('colaboradores');
                return;
            }
            document.getElementById('lancamentoModal').style.display = 'block';
            loadColaboradoresSelect();
        }

        function showEmpresaModal(editNome = null) {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }
            
            document.getElementById('empresaModal').style.display = 'block';
            
            if (editNome) {
                document.getElementById('empresaModalTitle').textContent = 'Editar Empresa';
                document.getElementById('empresaNome').value = editNome;
                document.getElementById('empresaNomeOriginal').value = editNome;
                
                const empresaDoc = empresasDocs.find(doc => doc.nome === editNome);
                if (empresaDoc) {
                    document.getElementById('empresaId').value = empresaDoc.id;
                }
            } else {
                document.getElementById('empresaModalTitle').textContent = 'Nova Empresa';
                document.getElementById('empresaId').value = '';
                document.getElementById('empresaNomeOriginal').value = '';
                document.getElementById('empresaNome').value = '';
            }
        }

        function showDepartamentoModal(editNome = null) {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }
            
            document.getElementById('departamentoModal').style.display = 'block';
            
            if (editNome) {
                document.getElementById('departamentoModalTitle').textContent = 'Editar Departamento';
                document.getElementById('departamentoNome').value = editNome;
                document.getElementById('departamentoNomeOriginal').value = editNome;
                
                const deptoDoc = departamentosDocs.find(doc => doc.nome === editNome);
                if (deptoDoc) {
                    document.getElementById('departamentoId').value = deptoDoc.id;
                }
            } else {
                document.getElementById('departamentoModalTitle').textContent = 'Novo Departamento';
                document.getElementById('departamentoId').value = '';
                document.getElementById('departamentoNomeOriginal').value = '';
                document.getElementById('departamentoNome').value = '';
            }
        }

        function showImportModal() {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }
            
            if (empresas.length === 0) {
                alert('Cadastre pelo menos uma empresa antes de importar colaboradores!');
                showTab('configuracoes');
                return;
            }
            
            if (departamentos.length === 0) {
                alert('Cadastre pelo menos um departamento antes de importar colaboradores!');
                showTab('configuracoes');
                return;
            }
            
            document.getElementById('importModal').style.display = 'block';
            showFileImport(); // Mostrar importa√ß√£o por arquivo por padr√£o
        }

        function showTextImport() {
            document.getElementById('textImportSection').style.display = 'block';
            document.getElementById('fileImportSection').style.display = 'none';
        }

        function showFileImport() {
            document.getElementById('textImportSection').style.display = 'none';
            document.getElementById('fileImportSection').style.display = 'block';
            resetFileImport();
        }

        function resetFileImport() {
            document.getElementById('fileInput').value = '';
            document.getElementById('fileName').innerHTML = '';
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('validationSummary').style.display = 'none';
            document.getElementById('importButton').disabled = true;
            importedData = [];
            importValidation = [];
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'colaboradorModal') {
                document.getElementById('colaboradorForm').reset();
            } else if (modalId === 'lancamentoModal') {
                document.getElementById('lancamentoForm').reset();
            } else if (modalId === 'empresaModal') {
                document.getElementById('empresaForm').reset();
            } else if (modalId === 'departamentoModal') {
                document.getElementById('departamentoForm').reset();
            } else if (modalId === 'importModal') {
                document.getElementById('importForm').reset();
                document.getElementById('importAlert').classList.add('hidden');
                resetFileImport();
            }
        }

        // Fun√ß√µes para o modelo de planilha
        function copyTemplate() {
            const template = document.getElementById('templateText').innerText;
            navigator.clipboard.writeText(template).then(() => {
                alert('Modelo copiado para a √°rea de transfer√™ncia!');
            });
        }

        function downloadTemplate() {
            const template = "Jo√£o Silva,01/01/2023,TI,Empresa A\nMaria Santos,15/03/2023,RH,Empresa B\nPedro Oliveira,10/02/2023,Financeiro,Empresa A";
            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'modelo_colaboradores.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Fun√ß√£o melhorada para validar e converter data
        function parseAndValidateDate(dateValue) {
            if (!dateValue && dateValue !== 0) return { valid: false, error: 'Data n√£o preenchida' };
            
            // Se for n√∫mero (Excel armazena data como n√∫mero de dias desde 1900)
            if (typeof dateValue === 'number') {
                try {
                    // Excel date to JavaScript date
                    // Excel usa 1/1/1900 como dia 1, mas tem um bug com o ano 1900
                    const excelEpoch = new Date(1900, 0, 1);
                    const jsDate = new Date(excelEpoch.getTime() + (dateValue - 1) * 24 * 60 * 60 * 1000);
                    
                    if (!isNaN(jsDate.getTime())) {
                        const day = String(jsDate.getDate()).padStart(2, '0');
                        const month = String(jsDate.getMonth() + 1).padStart(2, '0');
                        const year = jsDate.getFullYear();
                        return { 
                            valid: true, 
                            value: `${day}/${month}/${year}`,
                            formatted: `${day}/${month}/${year}`
                        };
                    }
                } catch (e) {
                    return { valid: false, error: 'Data inv√°lida (formato Excel)' };
                }
            }
            
            // Converter para string e remover espa√ßos
            const dateStr = String(dateValue).trim();
            
            // Tentar diferentes formatos de data
            
            // Formato DD/MM/AAAA ou DD-MM-AAAA
            const regex1 = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/;
            let match = dateStr.match(regex1);
            if (match) {
                const day = parseInt(match[1]);
                const month = parseInt(match[2]);
                const year = parseInt(match[3]);
                
                if (day >= 1 && day <= 31 && month >= 1 && month <= 12) {
                    const testDate = new Date(year, month - 1, day);
                    if (testDate.getDate() === day && testDate.getMonth() === month - 1) {
                        const formattedDay = String(day).padStart(2, '0');
                        const formattedMonth = String(month).padStart(2, '0');
                        return { 
                            valid: true, 
                            value: `${formattedDay}/${formattedMonth}/${year}`,
                            formatted: `${formattedDay}/${formattedMonth}/${year}`
                        };
                    }
                }
                return { valid: false, error: 'Data inv√°lida' };
            }
            
            // Formato DD/MM/YY ou DD-MM-YY
            const regex2 = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})$/;
            match = dateStr.match(regex2);
            if (match) {
                const day = parseInt(match[1]);
                const month = parseInt(match[2]);
                let year = parseInt(match[3]);
                
                // Assumir que anos entre 0-69 s√£o 2000-2069 e 70-99 s√£o 1970-1999
                year = year < 70 ? 2000 + year : 1900 + year;
                
                if (day >= 1 && day <= 31 && month >= 1 && month <= 12) {
                    const testDate = new Date(year, month - 1, day);
                    if (testDate.getDate() === day && testDate.getMonth() === month - 1) {
                        const formattedDay = String(day).padStart(2, '0');
                        const formattedMonth = String(month).padStart(2, '0');
                        return { 
                            valid: true, 
                            value: `${formattedDay}/${formattedMonth}/${year}`,
                            formatted: `${formattedDay}/${formattedMonth}/${year}`
                        };
                    }
                }
                return { valid: false, error: 'Data inv√°lida' };
            }
            
            // Tentar formato ISO (YYYY-MM-DD)
            const regex3 = /^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/;
            match = dateStr.match(regex3);
            if (match) {
                const year = parseInt(match[1]);
                const month = parseInt(match[2]);
                const day = parseInt(match[3]);
                
                if (day >= 1 && day <= 31 && month >= 1 && month <= 12) {
                    const testDate = new Date(year, month - 1, day);
                    if (testDate.getDate() === day && testDate.getMonth() === month - 1) {
                        const formattedDay = String(day).padStart(2, '0');
                        const formattedMonth = String(month).padStart(2, '0');
                        return { 
                            valid: true, 
                            value: `${formattedDay}/${formattedMonth}/${year}`,
                            formatted: `${formattedDay}/${formattedMonth}/${year}`
                        };
                    }
                }
                return { valid: false, error: 'Data inv√°lida' };
            }
            
            return { valid: false, error: 'Formato inv√°lido (use DD/MM/AAAA)' };
        }

        // Fun√ß√£o para validar data no formato DD/MM/AAAA (para uso em formul√°rios)
        function isValidDate(dateStr) {
            const result = parseAndValidateDate(dateStr);
            return result.valid;
        }

        // Fun√ß√µes para upload de arquivo
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('fileUploadArea').classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('fileUploadArea').classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('fileUploadArea').classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFile(file) {
            const fileName = file.name;
            document.getElementById('fileName').innerHTML = `üìÑ ${fileName}`;
            
            const fileExt = fileName.split('.').pop().toLowerCase();
            
            document.getElementById('progressBar').style.display = 'block';
            updateProgress(10);
            
            if (fileExt === 'csv' || fileExt === 'txt') {
                parseCSV(file);
            } else if (fileExt === 'xls' || fileExt === 'xlsx') {
                parseExcel(file);
            } else {
                alert('Formato de arquivo n√£o suportado. Use CSV, XLS, XLSX ou TXT.');
                resetFileImport();
            }
        }

        function parseCSV(file) {
            Papa.parse(file, {
                complete: function(results) {
                    processParsedData(results.data);
                },
                error: function(error) {
                    alert('Erro ao ler arquivo CSV: ' + error.message);
                    resetFileImport();
                }
            });
        }

        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    processParsedData(jsonData);
                } catch (error) {
                    alert('Erro ao ler arquivo Excel: ' + error.message);
                    resetFileImport();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processParsedData(data) {
            updateProgress(50);
            
            // Filtrar linhas vazias
            const validRows = data.filter(row => {
                return row && row.some && row.some(cell => cell && cell.toString().trim() !== '');
            });
            
            // Converter para formato padronizado
            importedData = validRows.map(row => {
                // Garantir que temos pelo menos 4 colunas
                while (row.length < 4) {
                    row.push('');
                }
                
                return {
                    nome: row[0] ? row[0].toString().trim() : '',
                    dataAdmissao: row[1], // Manter original para valida√ß√£o
                    departamento: row[2] ? row[2].toString().trim() : '',
                    empresa: row[3] ? row[3].toString().trim() : ''
                };
            });
            
            // Validar dados
            validateImportedData();
            
            updateProgress(100);
            setTimeout(() => {
                document.getElementById('progressBar').style.display = 'none';
            }, 500);
        }

        function validateImportedData() {
            importValidation = [];
            
            importedData.forEach((item, index) => {
                const errors = [];
                const warnings = [];
                let dataAdmissaoFormatada = item.dataAdmissao;
                
                // Validar nome
                if (!item.nome) {
                    errors.push('Nome n√£o preenchido');
                }
                
                // Validar data com a fun√ß√£o melhorada
                const dataResult = parseAndValidateDate(item.dataAdmissao);
                if (!dataResult.valid) {
                    errors.push(`Data: ${dataResult.error}`);
                } else {
                    dataAdmissaoFormatada = dataResult.value;
                }
                
                // Validar departamento
                if (!item.departamento) {
                    errors.push('Departamento n√£o preenchido');
                } else if (!departamentos.includes(item.departamento)) {
                    errors.push(`Departamento "${item.departamento}" n√£o cadastrado`);
                }
                
                // Validar empresa
                if (!item.empresa) {
                    errors.push('Empresa n√£o preenchida');
                } else if (!empresas.includes(item.empresa)) {
                    errors.push(`Empresa "${item.empresa}" n√£o cadastrada`);
                }
                
                importValidation.push({
                    linha: index + 1,
                    dados: {
                        ...item,
                        dataAdmissao: dataAdmissaoFormatada
                    },
                    errors: errors,
                    warnings: warnings,
                    valid: errors.length === 0
                });
            });
            
            displayValidationSummary();
        }

        function displayValidationSummary() {
            const summary = document.getElementById('validationSummary');
            const validCount = importValidation.filter(v => v.valid).length;
            const invalidCount = importValidation.filter(v => !v.valid).length;
            
            let html = `
                <div style="margin-bottom: 10px;">
                    <strong>Resumo da Valida√ß√£o:</strong><br>
                    <span style="color: #27ae60;">‚úì ${validCount} linha(s) v√°lida(s)</span><br>
                    <span style="color: #e74c3c;">‚úó ${invalidCount} linha(s) com erro(s)</span>
                </div>
            `;
            
            importValidation.forEach(v => {
                const statusClass = v.valid ? 'success' : 'error';
                html += `<div class="validation-item ${statusClass}">`;
                html += `<strong>Linha ${v.linha}:</strong> `;
                
                if (v.valid) {
                    html += `${v.dados.nome} - ${v.dados.dataAdmissao} - ${v.dados.departamento} - ${v.dados.empresa}`;
                } else {
                    html += `<br>${v.errors.join('<br>')}`;
                }
                
                html += '</div>';
            });
            
            summary.innerHTML = html;
            summary.style.display = 'block';
            
            document.getElementById('importButton').disabled = invalidCount > 0;
        }

        function updateProgress(percent) {
            const fill = document.getElementById('progressBarFill');
            fill.style.width = percent + '%';
            fill.textContent = percent + '%';
        }

        async function processFileImport() {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }
            
            const validData = importValidation.filter(v => v.valid).map(v => v.dados);
            
            if (validData.length === 0) {
                alert('N√£o h√° dados v√°lidos para importar!');
                return;
            }
            
            showLoading(true);
            updateProgress(10);
            
            try {
                let imported = 0;
                let errors = 0;
                
                for (let i = 0; i < validData.length; i++) {
                    const item = validData[i];
                    
                    try {
                        await db.collection('colaboradores').add({
                            nome: item.nome,
                            dataAdmissao: item.dataAdmissao,
                            departamento: item.departamento,
                            empresa: item.empresa,
                            horasPositivas: 0,
                            horasNegativas: 0,
                            ativo: true,
                            createdAt: new Date().toISOString()
                        });
                        imported++;
                        
                        const progress = 10 + Math.round((i + 1) / validData.length * 80);
                        updateProgress(progress);
                    } catch (error) {
                        console.error('Erro ao importar linha:', error);
                        errors++;
                    }
                }
                
                await loadData();
                updateProgress(100);
                
                let alertMessage = `‚úÖ Importa√ß√£o conclu√≠da! ${imported} colaborador(es) importado(s) com sucesso.`;
                if (errors > 0) {
                    alertMessage += `\n‚ùå ${errors} erro(s) durante a importa√ß√£o.`;
                }
                
                const alert = document.getElementById('importAlert');
                alert.textContent = alertMessage;
                alert.className = errors > 0 ? 'alert alert-warning' : 'alert alert-success';
                alert.classList.remove('hidden');
                
                setTimeout(() => {
                    hideModal('importModal');
                }, 5000);
                
            } catch (error) {
                console.error('Erro ao importar:', error);
                if (error.code === 'permission-denied') {
                    alert('Erro de permiss√£o! Configure as regras do Firebase conforme instru√ß√µes.');
                } else {
                    alert('Erro ao importar para o Firebase: ' + error.message);
                }
            }
            
            showLoading(false);
            updateProgress(0);
        }

        // Carregar dados do Firebase
        async function loadData() {
            if (!firebaseConnected) {
                showLoading(false);
                return;
            }
            
            showLoading(true);
            try {
                console.log('Carregando dados do Firebase...');

                // Carregar empresas
                try {
                    const empresasSnapshot = await db.collection('empresas').get();
                    empresasDocs = empresasSnapshot.docs.map(doc => ({
                        id: doc.id,
                        nome: doc.data().nome
                    }));
                    empresas = empresasDocs.map(doc => doc.nome);
                    console.log('Empresas carregadas:', empresas.length);
                } catch (error) {
                    console.error('Erro ao carregar empresas:', error);
                    empresas = [];
                    empresasDocs = [];
                }

                // Carregar departamentos
                try {
                    const departamentosSnapshot = await db.collection('departamentos').get();
                    departamentosDocs = departamentosSnapshot.docs.map(doc => ({
                        id: doc.id,
                        nome: doc.data().nome
                    }));
                    departamentos = departamentosDocs.map(doc => doc.nome);
                    console.log('Departamentos carregados:', departamentos.length);
                } catch (error) {
                    console.error('Erro ao carregar departamentos:', error);
                    departamentos = [];
                    departamentosDocs = [];
                }

                // Carregar colaboradores
                try {
                    const colaboradoresSnapshot = await db.collection('colaboradores').get();
                    colaboradores = colaboradoresSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Ordenar colaboradores em ordem alfab√©tica
                    colaboradores.sort((a, b) => a.nome.localeCompare(b.nome));
                    console.log('Colaboradores carregados:', colaboradores.length);
                } catch (error) {
                    console.error('Erro ao carregar colaboradores:', error);
                    colaboradores = [];
                }

                // Carregar lan√ßamentos
                try {
                    const lancamentosSnapshot = await db.collection('lancamentos').orderBy('data', 'desc').get();
                    lancamentos = lancamentosSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    console.log('Lan√ßamentos carregados:', lancamentos.length);
                } catch (error) {
                    console.error('Erro ao carregar lan√ßamentos:', error);
                    lancamentos = [];
                }

                // Calcular saldo dos colaboradores baseado nos lan√ßamentos
                calcularSaldos();

                updateAllTables();
            } catch (error) {
                console.error('Erro geral ao carregar dados:', error);
                if (error.code === 'permission-denied') {
                    alert('Permiss√£o negada! Configure as regras do Firebase.');
                } else {
                    alert('Erro ao carregar dados: ' + error.message);
                }
            } finally {
                showLoading(false);
            }
        }

        // Fun√ß√£o para calcular saldo dos colaboradores
        function calcularSaldos() {
            colaboradores.forEach(colab => {
                colab.horasPositivas = 0;
                colab.horasNegativas = 0;
            });

            lancamentos.forEach(lanc => {
                const colaborador = colaboradores.find(c => c.id === lanc.colaboradorId);
                if (colaborador) {
                    if (lanc.tipo === 'positiva') {
                        colaborador.horasPositivas = (colaborador.horasPositivas || 0) + lanc.horas;
                    } else {
                        colaborador.horasNegativas = (colaborador.horasNegativas || 0) + lanc.horas;
                    }
                }
            });
        }

        // Carregar selects
        function loadSelects() {
            const deptoSelect = document.getElementById('colaboradorDepartamento');
            const empresaSelect = document.getElementById('colaboradorEmpresa');
            
            deptoSelect.innerHTML = '<option value="">Selecione...</option>';
            empresaSelect.innerHTML = '<option value="">Selecione...</option>';
            
            if (departamentos.length > 0) {
                departamentos.sort().forEach(depto => {
                    deptoSelect.innerHTML += `<option value="${depto}">${depto}</option>`;
                });
            }
            
            if (empresas.length > 0) {
                empresas.sort().forEach(empresa => {
                    empresaSelect.innerHTML += `<option value="${empresa}">${empresa}</option>`;
                });
            }
        }

        function loadColaboradoresSelect() {
            const select = document.getElementById('lancamentoColaborador');
            select.innerHTML = '<option value="">Selecione...</option>';
            colaboradores
                .filter(c => c.ativo !== false)
                .forEach(colab => {
                    select.innerHTML += `<option value="${colab.id}">${colab.nome}</option>`;
                });
        }

        function atualizarSelectColaboradores() {
            const select = document.getElementById('filtroColaborador');
            select.innerHTML = '<option value="">-- Selecione um colaborador --</option>';
            colaboradores
                .filter(c => c.ativo !== false)
                .forEach(colab => {
                    select.innerHTML += `<option value="${colab.id}">${colab.nome}</option>`;
                });
        }

        // Fun√ß√µes para filtro de lan√ßamentos
        function filtrarLancamentos() {
            const colaboradorId = document.getElementById('filtroColaborador').value;
            const mes = document.getElementById('filtroMes').value;
            const ano = document.getElementById('filtroAno').value;
            
            const resumoDiv = document.getElementById('resumoMensal');
            const tabela = document.getElementById('lancamentosTable');
            const semSelecaoMsg = document.getElementById('semSelecaoMsg');
            
            if (!colaboradorId) {
                resumoDiv.style.display = 'none';
                tabela.style.display = 'none';
                semSelecaoMsg.style.display = 'block';
                return;
            }
            
            // Filtrar lan√ßamentos do colaborador no m√™s/ano selecionado
            const lancamentosFiltrados = lancamentos.filter(lanc => {
                if (lanc.colaboradorId !== colaboradorId) return false;
                
                // Extrair m√™s e ano da data (formato DD/MM/AAAA)
                const partes = lanc.data.split('/');
                if (partes.length !== 3) return false;
                
                const lancMes = partes[1];
                const lancAno = partes[2];
                
                return lancMes === mes && lancAno === ano;
            });
            
            // Calcular resumo
            let totalPositivas = 0;
            let totalNegativas = 0;
            
            lancamentosFiltrados.forEach(lanc => {
                if (lanc.tipo === 'positiva') {
                    totalPositivas += lanc.horas;
                } else {
                    totalNegativas += lanc.horas;
                }
            });
            
            const saldo = totalPositivas - totalNegativas;
            
            // Atualizar resumo
            document.getElementById('resumoPositivas').textContent = totalPositivas.toFixed(1);
            document.getElementById('resumoNegativas').textContent = totalNegativas.toFixed(1);
            document.getElementById('resumoSaldo').textContent = saldo.toFixed(1);
            
            // Atualizar tabela
            const tbody = document.getElementById('lancamentosList');
            tbody.innerHTML = '';
            
            if (lancamentosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Nenhum lan√ßamento encontrado para este per√≠odo.</td></tr>';
            } else {
                lancamentosFiltrados.sort((a, b) => {
                    // Ordenar por data (considerando formato DD/MM/AAAA)
                    const [dA, mA, yA] = a.data.split('/');
                    const [dB, mB, yB] = b.data.split('/');
                    const dataA = new Date(yA, mA - 1, dA);
                    const dataB = new Date(yB, mB - 1, dB);
                    return dataB - dataA; // Mais recentes primeiro
                });
                
                lancamentosFiltrados.forEach(lanc => {
                    const tipoClass = lanc.tipo === 'positiva' ? 'status-positive' : 'status-negative';
                    const tipoText = lanc.tipo === 'positiva' ? 'Hora Extra' : 'D√©bito';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${lanc.data}</td>
                            <td class="${tipoClass}">${tipoText}</td>
                            <td>${lanc.horas} h</td>
                            <td>${lanc.descricao || '-'}</td>
                            <td>
                                <button class="btn btn-danger btn-small" onclick="deleteLancamento('${lanc.id}')">Excluir</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            resumoDiv.style.display = 'flex';
            tabela.style.display = 'table';
            semSelecaoMsg.style.display = 'none';
        }

        function limparFiltros() {
            document.getElementById('filtroColaborador').value = '';
            const anoAtual = new Date().getFullYear().toString();
            document.getElementById('filtroMes').value = '01';
            document.getElementById('filtroAno').value = anoAtual;
            
            document.getElementById('resumoMensal').style.display = 'none';
            document.getElementById('lancamentosTable').style.display = 'none';
            document.getElementById('semSelecaoMsg').style.display = 'block';
        }

        // Salvar empresa
        async function saveEmpresa() {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }

            const id = document.getElementById('empresaId').value;
            const nome = document.getElementById('empresaNome').value.trim();
            const nomeOriginal = document.getElementById('empresaNomeOriginal').value;

            if (!nome) {
                alert('Digite um nome para a empresa');
                return;
            }

            if ((!id || nome !== nomeOriginal) && empresas.includes(nome)) {
                alert('Esta empresa j√° est√° cadastrada!');
                return;
            }

            showLoading(true);
            try {
                if (id) {
                    await db.collection('empresas').doc(id).update({ 
                        nome,
                        updatedAt: new Date().toISOString()
                    });
                    
                    if (nome !== nomeOriginal) {
                        const colaboradoresEmpresa = colaboradores.filter(c => c.empresa === nomeOriginal);
                        for (const colab of colaboradoresEmpresa) {
                            await db.collection('colaboradores').doc(colab.id).update({
                                empresa: nome,
                                updatedAt: new Date().toISOString()
                            });
                        }
                    }
                    
                    alert('Empresa atualizada com sucesso!');
                } else {
                    await db.collection('empresas').add({ 
                        nome,
                        createdAt: new Date().toISOString()
                    });
                    alert('Empresa cadastrada com sucesso!');
                }
                
                await loadData();
                hideModal('empresaModal');
            } catch (error) {
                console.error('Erro ao salvar empresa:', error);
                if (error.code === 'permission-denied') {
                    alert('Erro de permiss√£o! Configure as regras do Firebase conforme instru√ß√µes.');
                } else {
                    alert('Erro ao salvar no Firebase: ' + error.message);
                }
            }
            showLoading(false);
        }

        // Salvar departamento
        async function saveDepartamento() {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }

            const id = document.getElementById('departamentoId').value;
            const nome = document.getElementById('departamentoNome').value.trim();
            const nomeOriginal = document.getElementById('departamentoNomeOriginal').value;

            if (!nome) {
                alert('Digite um nome para o departamento');
                return;
            }

            if ((!id || nome !== nomeOriginal) && departamentos.includes(nome)) {
                alert('Este departamento j√° est√° cadastrado!');
                return;
            }

            showLoading(true);
            try {
                if (id) {
                    await db.collection('departamentos').doc(id).update({ 
                        nome,
                        updatedAt: new Date().toISOString()
                    });
                    
                    if (nome !== nomeOriginal) {
                        const colaboradoresDepto = colaboradores.filter(c => c.departamento === nomeOriginal);
                        for (const colab of colaboradoresDepto) {
                            await db.collection('colaboradores').doc(colab.id).update({
                                departamento: nome,
                                updatedAt: new Date().toISOString()
                            });
                        }
                    }
                    
                    alert('Departamento atualizado com sucesso!');
                } else {
                    await db.collection('departamentos').add({ 
                        nome,
                        createdAt: new Date().toISOString()
                    });
                    alert('Departamento cadastrado com sucesso!');
                }
                
                await loadData();
                hideModal('departamentoModal');
            } catch (error) {
                console.error('Erro ao salvar departamento:', error);
                if (error.code === 'permission-denied') {
                    alert('Erro de permiss√£o! Configure as regras do Firebase conforme instru√ß√µes.');
                } else {
                    alert('Erro ao salvar no Firebase: ' + error.message);
                }
            }
            showLoading(false);
        }

        // Salvar colaborador
        async function saveColaborador() {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }

            const id = document.getElementById('colaboradorId').value;
            const nome = document.getElementById('colaboradorNome').value.trim();
            const data = document.getElementById('colaboradorData').value;
            const departamento = document.getElementById('colaboradorDepartamento').value;
            const empresa = document.getElementById('colaboradorEmpresa').value;
            const ativo = document.getElementById('colaboradorAtivo').checked;

            if (!isValidDate(data)) {
                alert('Data inv√°lida! Use o formato DD/MM/AAAA');
                return;
            }

            showLoading(true);
            try {
                const colaboradorData = {
                    nome,
                    dataAdmissao: data,
                    departamento,
                    empresa,
                    horasPositivas: 0,
                    horasNegativas: 0,
                    ativo: ativo,
                    updatedAt: new Date().toISOString()
                };

                if (id) {
                    await db.collection('colaboradores').doc(id).update(colaboradorData);
                    alert('Colaborador atualizado com sucesso!');
                } else {
                    colaboradorData.createdAt = new Date().toISOString();
                    await db.collection('colaboradores').add(colaboradorData);
                    alert('Colaborador cadastrado com sucesso!');
                }

                await loadData();
                hideModal('colaboradorModal');
            } catch (error) {
                console.error('Erro ao salvar colaborador:', error);
                if (error.code === 'permission-denied') {
                    alert('Erro de permiss√£o! Configure as regras do Firebase conforme instru√ß√µes.');
                } else {
                    alert('Erro ao salvar no Firebase: ' + error.message);
                }
            }
            showLoading(false);
        }

        // Salvar lan√ßamento
        async function saveLancamento() {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }

            const colaboradorId = document.getElementById('lancamentoColaborador').value;
            const mes = document.getElementById('lancamentoMes').value;
            const ano = document.getElementById('lancamentoAno').value;
            const tipo = document.getElementById('lancamentoTipo').value;
            const horas = parseFloat(document.getElementById('lancamentoHoras').value);
            const descricao = document.getElementById('lancamentoDescricao').value.trim();

            if (!colaboradorId || !mes || !ano || !horas) {
                alert('Preencha todos os campos corretamente!');
                return;
            }

            if (horas <= 0) {
                alert('A quantidade de horas deve ser maior que zero!');
                return;
            }

            const colaborador = colaboradores.find(c => c.id === colaboradorId);
            if (!colaborador) return;

            if (colaborador.ativo === false) {
                if (!confirm('Este colaborador est√° inativo. Deseja continuar com o lan√ßamento?')) {
                    return;
                }
            }

            // Criar data no formato DD/MM/AAAA (usando o primeiro dia do m√™s)
            const data = `01/${mes}/${ano}`;

            showLoading(true);
            try {
                const lancamentoData = {
                    colaboradorId,
                    colaboradorNome: colaborador.nome,
                    data,
                    mes,
                    ano,
                    tipo,
                    horas,
                    descricao: descricao || 'Sem descri√ß√£o',
                    createdAt: new Date().toISOString()
                };

                await db.collection('lancamentos').add(lancamentoData);
                await loadData();
                hideModal('lancamentoModal');
                
                // Atualizar visualiza√ß√£o se o filtro estiver no mesmo colaborador/per√≠odo
                const filtroColab = document.getElementById('filtroColaborador').value;
                const filtroMes = document.getElementById('filtroMes').value;
                const filtroAno = document.getElementById('filtroAno').value;
                
                if (filtroColab === colaboradorId && filtroMes === mes && filtroAno === ano) {
                    filtrarLancamentos();
                }
                
                alert('Lan√ßamento realizado com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar lan√ßamento:', error);
                if (error.code === 'permission-denied') {
                    alert('Erro de permiss√£o! Configure as regras do Firebase conforme instru√ß√µes.');
                } else {
                    alert('Erro ao salvar no Firebase: ' + error.message);
                }
            }
            showLoading(false);
        }

        // Importar colaboradores (modo texto)
        async function importColaboradores() {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }

            const data = document.getElementById('importData').value;
            const lines = data.split('\n');
            let imported = 0;
            let errors = 0;
            let errorsList = [];

            showLoading(true);
            try {
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const [nome, dataAdmissao, departamento, empresa] = line.split(',').map(item => item.trim());
                        
                        if (nome && dataAdmissao && departamento && empresa) {
                            if (!departamentos.includes(departamento)) {
                                errors++;
                                errorsList.push(`Linha ${i + 1}: Departamento "${departamento}" n√£o existe`);
                                continue;
                            }
                            
                            if (!empresas.includes(empresa)) {
                                errors++;
                                errorsList.push(`Linha ${i + 1}: Empresa "${empresa}" n√£o existe`);
                                continue;
                            }
                            
                            const dataResult = parseAndValidateDate(dataAdmissao);
                            if (dataResult.valid) {
                                await db.collection('colaboradores').add({
                                    nome,
                                    dataAdmissao: dataResult.value,
                                    departamento,
                                    empresa,
                                    horasPositivas: 0,
                                    horasNegativas: 0,
                                    ativo: true,
                                    createdAt: new Date().toISOString()
                                });
                                imported++;
                            } else {
                                errors++;
                                errorsList.push(`Linha ${i + 1}: Data inv√°lida (${dataAdmissao}) - ${dataResult.error}`);
                            }
                        } else {
                            errors++;
                            errorsList.push(`Linha ${i + 1}: Formato inv√°lido`);
                        }
                    }
                }

                await loadData();

                let alertMessage = `‚úÖ Importa√ß√£o conclu√≠da! ${imported} colaborador(es) importado(s) com sucesso.`;
                if (errors > 0) {
                    alertMessage += `\n‚ùå ${errors} erro(s):\n${errorsList.join('\n')}`;
                }

                const alert = document.getElementById('importAlert');
                alert.textContent = alertMessage;
                alert.className = errors > 0 ? 'alert alert-error' : 'alert alert-success';
                alert.classList.remove('hidden');

                setTimeout(() => {
                    hideModal('importModal');
                }, 8000);
            } catch (error) {
                console.error('Erro ao importar:', error);
                if (error.code === 'permission-denied') {
                    alert('Erro de permiss√£o! Configure as regras do Firebase conforme instru√ß√µes.');
                } else {
                    alert('Erro ao importar para o Firebase: ' + error.message);
                }
            }
            showLoading(false);
        }

        // Fun√ß√µes de filtro e ordena√ß√£o para colaboradores
        function filterColaboradores() {
            const searchTerm = document.getElementById('searchColaborador').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const deptoFilter = document.getElementById('filterDepartamento').value;
            const empresaFilter = document.getElementById('filterEmpresa').value;

            colaboradoresFiltrados = colaboradores.filter(colab => {
                const matchSearch = colab.nome.toLowerCase().includes(searchTerm) ||
                                  colab.departamento.toLowerCase().includes(searchTerm) ||
                                  colab.empresa.toLowerCase().includes(searchTerm);
                const matchDepto = !deptoFilter || colab.departamento === deptoFilter;
                const matchEmpresa = !empresaFilter || colab.empresa === empresaFilter;
                
                // Filtro de status
                let matchStatus = true;
                if (statusFilter === 'ativos') {
                    matchStatus = colab.ativo !== false;
                } else if (statusFilter === 'inativos') {
                    matchStatus = colab.ativo === false;
                }
                
                return matchSearch && matchDepto && matchEmpresa && matchStatus;
            });

            sortColaboradores(sortField);
            currentPage = 1;
            updateColaboradoresTable();
        }

        function sortColaboradores(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }

            colaboradoresFiltrados.sort((a, b) => {
                let valA = a[field];
                let valB = b[field];
                
                if (field === 'dataAdmissao') {
                    const [dA, mA, yA] = valA.split('/');
                    const [dB, mB, yB] = valB.split('/');
                    valA = new Date(yA, mA - 1, dA);
                    valB = new Date(yB, mB - 1, dB);
                } else {
                    valA = String(valA || '').toLowerCase();
                    valB = String(valB || '').toLowerCase();
                }
                
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            updateColaboradoresTable();
        }

        // Atualizar todas as tabelas
        function updateAllTables() {
            updateFilterOptions();
            colaboradoresFiltrados = [...colaboradores].filter(c => c.ativo !== false);
            sortColaboradores('nome');
            updateLancamentosTable();
            updateEmpresasTable();
            updateDepartamentosTable();
            updateDashboard();
            loadColaboradoresSelect();
            atualizarSelectColaboradores();
            preencherAnos();
        }

        function updateFilterOptions() {
            const deptoSelect = document.getElementById('filterDepartamento');
            const empresaSelect = document.getElementById('filterEmpresa');
            
            deptoSelect.innerHTML = '<option value="">Todos Departamentos</option>';
            empresaSelect.innerHTML = '<option value="">Todas Empresas</option>';
            
            const deptosUnicos = [...new Set(colaboradores.map(c => c.departamento))];
            deptosUnicos.sort().forEach(depto => {
                deptoSelect.innerHTML += `<option value="${depto}">${depto}</option>`;
            });
            
            const empresasUnicas = [...new Set(colaboradores.map(c => c.empresa))];
            empresasUnicas.sort().forEach(empresa => {
                empresaSelect.innerHTML += `<option value="${empresa}">${empresa}</option>`;
            });
        }

        function updateColaboradoresTable() {
            const tbody = document.getElementById('colaboradoresList');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedColabs = colaboradoresFiltrados.slice(start, end);

            tbody.innerHTML = '';

            if (colaboradoresFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">Nenhum colaborador encontrado. Clique em "Novo Colaborador" para come√ßar.</td></tr>';
                updatePagination();
                return;
            }

            paginatedColabs.forEach(colab => {
                const saldo = (colab.horasPositivas || 0) - (colab.horasNegativas || 0);
                const statusClass = saldo >= 0 ? 'status-positive' : 'status-negative';
                const statusText = colab.ativo !== false ? 
                    '<span class="badge badge-ativo">Ativo</span>' : 
                    '<span class="badge badge-inativo">Inativo</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${colab.nome}</td>
                        <td>${colab.dataAdmissao}</td>
                        <td>${colab.departamento}</td>
                        <td>${colab.empresa}</td>
                        <td class="${statusClass}">${saldo} h</td>
                        <td>${statusText}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-small" onclick="showColaboradorModal('${colab.id}')">Editar</button>
                                <button class="btn btn-danger btn-small" onclick="deleteColaborador('${colab.id}')">Excluir</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(colaboradoresFiltrados.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            updateColaboradoresTable();
        }

        function updateLancamentosTable() {
            // Esta fun√ß√£o mantida para compatibilidade, mas n√£o √© mais usada diretamente
            // Os lan√ßamentos agora s√£o filtrados por colaborador/per√≠odo
        }

        function updateEmpresasTable() {
            const tbody = document.getElementById('empresasList');
            const alert = document.getElementById('empresasAlert');
            
            tbody.innerHTML = '';

            if (empresas.length === 0) {
                alert.classList.remove('hidden');
                return;
            }

            alert.classList.add('hidden');
            empresas.sort().forEach(empresa => {
                tbody.innerHTML += `
                    <tr>
                        <td>${empresa}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-small" onclick="showEmpresaModal('${empresa}')">Editar</button>
                                <button class="btn btn-danger btn-small" onclick="deleteEmpresa('${empresa}')">Excluir</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function updateDepartamentosTable() {
            const tbody = document.getElementById('departamentosList');
            const alert = document.getElementById('departamentosAlert');
            
            tbody.innerHTML = '';

            if (departamentos.length === 0) {
                alert.classList.remove('hidden');
                return;
            }

            alert.classList.add('hidden');
            departamentos.sort().forEach(depto => {
                tbody.innerHTML += `
                    <tr>
                        <td>${depto}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-small" onclick="showDepartamentoModal('${depto}')">Editar</button>
                                <button class="btn btn-danger btn-small" onclick="deleteDepartamento('${depto}')">Excluir</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // Deletar fun√ß√µes
        async function deleteColaborador(id) {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }

            const colaborador = colaboradores.find(c => c.id === id);
            if (!colaborador) return;

            if (confirm(`Tem certeza que deseja excluir o colaborador "${colaborador.nome}"? Todos os lan√ßamentos relacionados tamb√©m ser√£o exclu√≠dos.`)) {
                showLoading(true);
                try {
                    const lancamentosRelacionados = lancamentos.filter(l => l.colaboradorId === id);
                    for (const lanc of lancamentosRelacionados) {
                        await db.collection('lancamentos').doc(lanc.id).delete();
                    }
                    
                    await db.collection('colaboradores').doc(id).delete();
                    await loadData();
                    alert('Colaborador exclu√≠do com sucesso!');
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    if (error.code === 'permission-denied') {
                        alert('Erro de permiss√£o! Configure as regras do Firebase conforme instru√ß√µes.');
                    } else {
                        alert('Erro ao deletar do Firebase: ' + error.message);
                    }
                }
                showLoading(false);
            }
        }

        async function deleteEmpresa(nome) {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }

            const colaboradoresNaEmpresa = colaboradores.filter(c => c.empresa === nome);
            if (colaboradoresNaEmpresa.length > 0) {
                alert(`N√£o √© poss√≠vel excluir esta empresa pois existem ${colaboradoresNaEmpresa.length} colaborador(es) vinculados a ela.`);
                return;
            }

            if (confirm(`Tem certeza que deseja excluir a empresa "${nome}"?`)) {
                showLoading(true);
                try {
                    const empresaDoc = empresasDocs.find(doc => doc.nome === nome);
                    if (empresaDoc) {
                        await db.collection('empresas').doc(empresaDoc.id).delete();
                        await loadData();
                        alert('Empresa exclu√≠da com sucesso!');
                    }
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    if (error.code === 'permission-denied') {
                        alert('Erro de permiss√£o! Configure as regras do Firebase conforme instru√ß√µes.');
                    } else {
                        alert('Erro ao deletar do Firebase: ' + error.message);
                    }
                }
                showLoading(false);
            }
        }

        async function deleteDepartamento(nome) {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }

            const colaboradoresNoDepto = colaboradores.filter(c => c.departamento === nome);
            if (colaboradoresNoDepto.length > 0) {
                alert(`N√£o √© poss√≠vel excluir este departamento pois existem ${colaboradoresNoDepto.length} colaborador(es) vinculados a ele.`);
                return;
            }

            if (confirm(`Tem certeza que deseja excluir o departamento "${nome}"?`)) {
                showLoading(true);
                try {
                    const deptoDoc = departamentosDocs.find(doc => doc.nome === nome);
                    if (deptoDoc) {
                        await db.collection('departamentos').doc(deptoDoc.id).delete();
                        await loadData();
                        alert('Departamento exclu√≠do com sucesso!');
                    }
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    if (error.code === 'permission-denied') {
                        alert('Erro de permiss√£o! Configure as regras do Firebase conforme instru√ß√µes.');
                    } else {
                        alert('Erro ao deletar do Firebase: ' + error.message);
                    }
                }
                showLoading(false);
            }
        }

        async function deleteLancamento(id) {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase. Verifique sua internet e as configura√ß√µes.');
                return;
            }

            const lancamento = lancamentos.find(l => l.id === id);
            if (!lancamento) return;

            if (confirm(`Tem certeza que deseja excluir este lan√ßamento de ${lancamento.horas}h para ${lancamento.colaboradorNome}?`)) {
                showLoading(true);
                try {
                    await db.collection('lancamentos').doc(id).delete();
                    await loadData();
                    
                    // Atualizar visualiza√ß√£o se necess√°rio
                    const filtroColab = document.getElementById('filtroColaborador').value;
                    const filtroMes = document.getElementById('filtroMes').value;
                    const filtroAno = document.getElementById('filtroAno').value;
                    
                    if (filtroColab && filtroMes && filtroAno) {
                        filtrarLancamentos();
                    }
                    
                    alert('Lan√ßamento exclu√≠do com sucesso!');
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    if (error.code === 'permission-denied') {
                        alert('Erro de permiss√£o! Configure as regras do Firebase conforme instru√ß√µes.');
                    } else {
                        alert('Erro ao deletar do Firebase: ' + error.message);
                    }
                }
                showLoading(false);
            }
        }

        // Atualizar Dashboard
        function updateDashboard() {
            document.getElementById('totalColaboradores').textContent = colaboradores.filter(c => c.ativo !== false).length;
            
            let totalPositivas = colaboradores.reduce((sum, colab) => sum + (colab.horasPositivas || 0), 0);
            let totalNegativas = colaboradores.reduce((sum, colab) => sum + (colab.horasNegativas || 0), 0);
            
            document.getElementById('totalHorasPositivas').textContent = totalPositivas;
            document.getElementById('totalHorasNegativas').textContent = totalNegativas;
            document.getElementById('saldoLiquido').textContent = totalPositivas - totalNegativas;

            const activities = document.getElementById('recentActivities');
            
            if (lancamentos.length === 0) {
                activities.innerHTML = '<div class="activity-item">Nenhum lan√ßamento recente</div>';
                return;
            }

            activities.innerHTML = lancamentos.slice(0, 10).map(lanc => {
                const colaborador = colaboradores.find(c => c.id === lanc.colaboradorId);
                const statusClass = colaborador && colaborador.ativo === false ? 'status-inativo' : '';
                return `
                    <div class="activity-item ${statusClass}">
                        <span><strong>${lanc.colaboradorNome}</strong> ${colaborador && colaborador.ativo === false ? '(Inativo)' : ''} - ${lanc.tipo === 'positiva' ? '+' : '-'}${lanc.horas}h</span>
                        <span>${lanc.data}</span>
                    </div>
                `;
            }).join('');
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Iniciando aplica√ß√£o...');
            preencherAnos();
        });

        // Fechar modais ao clicar fora
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>