<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Banco de Horas - Firebase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
        }

        .sidebar h2 {
            padding: 0 20px;
            margin-bottom: 30px;
            font-size: 1.2rem;
            border-bottom: 1px solid #34495e;
            padding-bottom: 10px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .sidebar li:hover {
            background-color: #34495e;
        }

        .sidebar li.active {
            background-color: #3498db;
            border-left: 4px solid #2980b9;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            background-color: #f5f5f5;
        }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .card .subtitle {
            color: #7f8c8d;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .recent-activities {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .recent-activities h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        /* Forms and Tables */
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        table {
            width: 100%;
            background-color: white;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        th {
            background-color: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 0.9rem;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .status-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Banco de Horas</h2>
            <ul>
                <li class="active" onclick="showTab('dashboard')">Dashboard</li>
                <li onclick="showTab('colaboradores')">Colaboradores</li>
                <li onclick="showTab('lancamentos')">Lançamentos</li>
                <li onclick="showTab('configuracoes')">Configurações</li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2>Dashboard</h2>
                <div class="dashboard">
                    <div class="card">
                        <h3>Total de Colaboradores</h3>
                        <div class="number" id="totalColaboradores">0</div>
                        <div class="subtitle">Ativos no sistema</div>
                    </div>
                    <div class="card">
                        <h3>Horas Positivas</h3>
                        <div class="number" id="totalHorasPositivas">0</div>
                        <div class="subtitle">Total de horas a compensar</div>
                    </div>
                    <div class="card">
                        <h3>Horas Negativas</h3>
                        <div class="number" id="totalHorasNegativas">0</div>
                        <div class="subtitle">Total de horas em débito</div>
                    </div>
                    <div class="card">
                        <h3>Saldo Líquido</h3>
                        <div class="number" id="saldoLiquido">0</div>
                        <div class="subtitle">Positivo - Negativo</div>
                    </div>
                </div>

                <div class="recent-activities">
                    <h3>Últimos Lançamentos</h3>
                    <div id="recentActivities">
                        <!-- Atividades serão inseridas aqui via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Colaboradores Tab -->
            <div id="colaboradores" class="tab-content">
                <div class="header-actions">
                    <h2>Colaboradores</h2>
                    <div>
                        <button class="btn btn-success" onclick="showImportModal()">Importar Planilha</button>
                        <button class="btn btn-primary" onclick="showColaboradorModal()">Novo Colaborador</button>
                    </div>
                </div>

                <div id="importAlert" class="alert hidden"></div>

                <table id="colaboradoresTable">
                    <thead>
                        <tr>
                            <th>Nome Completo</th>
                            <th>Data de Admissão</th>
                            <th>Departamento</th>
                            <th>Empresa</th>
                            <th>Saldo de Horas</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="colaboradoresList">
                        <!-- Colaboradores serão inseridos aqui via JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Lançamentos Tab -->
            <div id="lancamentos" class="tab-content">
                <div class="header-actions">
                    <h2>Lançamentos de Horas</h2>
                    <button class="btn btn-primary" onclick="showLancamentoModal()">Novo Lançamento</button>
                </div>

                <table id="lancamentosTable">
                    <thead>
                        <tr>
                            <th>Colaborador</th>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Quantidade</th>
                            <th>Descrição</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="lancamentosList">
                        <!-- Lançamentos serão inseridos aqui via JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Configurações Tab -->
            <div id="configuracoes" class="tab-content">
                <h2>Configurações</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- Empresas -->
                    <div class="card">
                        <div class="header-actions" style="margin-bottom: 15px;">
                            <h3>Empresas</h3>
                            <button class="btn btn-primary" onclick="showEmpresaModal()">Nova Empresa</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="empresasList">
                                <!-- Empresas serão inseridas aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Departamentos -->
                    <div class="card">
                        <div class="header-actions" style="margin-bottom: 15px;">
                            <h3>Departamentos</h3>
                            <button class="btn btn-primary" onclick="showDepartamentoModal()">Novo Departamento</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="departamentosList">
                                <!-- Departamentos serão inseridos aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Colaborador -->
    <div id="colaboradorModal" class="modal">
        <div class="modal-content">
            <h3 id="colaboradorModalTitle">Novo Colaborador</h3>
            <form id="colaboradorForm" onsubmit="event.preventDefault(); saveColaborador();">
                <input type="hidden" id="colaboradorId">
                <div class="form-group">
                    <label>Nome Completo:</label>
                    <input type="text" id="colaboradorNome" required>
                </div>
                <div class="form-group">
                    <label>Data de Admissão:</label>
                    <input type="text" id="colaboradorData" placeholder="DD/MM/AAAA" required>
                </div>
                <div class="form-group">
                    <label>Departamento:</label>
                    <select id="colaboradorDepartamento" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Empresa:</label>
                    <select id="colaboradorEmpresa" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="hideModal('colaboradorModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Lançamento -->
    <div id="lancamentoModal" class="modal">
        <div class="modal-content">
            <h3>Novo Lançamento de Horas</h3>
            <form id="lancamentoForm" onsubmit="event.preventDefault(); saveLancamento();">
                <div class="form-group">
                    <label>Colaborador:</label>
                    <select id="lancamentoColaborador" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Data do Lançamento:</label>
                    <input type="text" id="lancamentoData" placeholder="DD/MM/AAAA" required>
                </div>
                <div class="form-group">
                    <label>Tipo:</label>
                    <select id="lancamentoTipo" required>
                        <option value="positiva">Hora Positiva (Extras)</option>
                        <option value="negativa">Hora Negativa (Débitos)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantidade de Horas:</label>
                    <input type="number" id="lancamentoHoras" step="0.5" min="0" required>
                </div>
                <div class="form-group">
                    <label>Descrição:</label>
                    <textarea id="lancamentoDescricao" rows="3" placeholder="Motivo do lançamento..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="hideModal('lancamentoModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Empresa -->
    <div id="empresaModal" class="modal">
        <div class="modal-content">
            <h3>Nova Empresa</h3>
            <form id="empresaForm" onsubmit="event.preventDefault(); saveEmpresa();">
                <div class="form-group">
                    <label>Nome da Empresa:</label>
                    <input type="text" id="empresaNome" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="hideModal('empresaModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Departamento -->
    <div id="departamentoModal" class="modal">
        <div class="modal-content">
            <h3>Novo Departamento</h3>
            <form id="departamentoForm" onsubmit="event.preventDefault(); saveDepartamento();">
                <div class="form-group">
                    <label>Nome do Departamento:</label>
                    <input type="text" id="departamentoNome" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="hideModal('departamentoModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Importação -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <h3>Importar Planilha de Colaboradores</h3>
            <p style="margin-bottom: 15px; color: #7f8c8d;">Formato esperado: Nome, Data de Admissão (DD/MM/AAAA), Departamento, Empresa</p>
            <form id="importForm" onsubmit="event.preventDefault(); importColaboradores();">
                <div class="form-group">
                    <label>Cole os dados da planilha:</label>
                    <textarea id="importData" rows="10" style="width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px;" placeholder="João Silva,01/01/2023,TI,Empresa A&#10;Maria Santos,15/03/2023,RH,Empresa B" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="hideModal('importModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Importar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDY6qtn4JJPXggiswJjUZCt866oycv_LHk",
            authDomain: "gestao-de-banco-de-horas.firebaseapp.com",
            projectId: "gestao-de-banco-de-horas",
            storageBucket: "gestao-de-banco-de-horas.firebasestorage.app",
            messagingSenderId: "1071713106694",
            appId: "1:1071713106694:web:0a164293419ba46b6e7c87"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variáveis globais
        let colaboradores = [];
        let lancamentos = [];
        let empresas = [];
        let departamentos = [];

        // Função para mostrar/esconder loading
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Função para mostrar tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.sidebar li').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Funções para modais
        function showColaboradorModal(editId = null) {
            document.getElementById('colaboradorModal').style.display = 'block';
            if (editId) {
                document.getElementById('colaboradorModalTitle').textContent = 'Editar Colaborador';
                const colab = colaboradores.find(c => c.id === editId);
                if (colab) {
                    document.getElementById('colaboradorId').value = colab.id;
                    document.getElementById('colaboradorNome').value = colab.nome;
                    document.getElementById('colaboradorData').value = colab.dataAdmissao;
                    document.getElementById('colaboradorDepartamento').value = colab.departamento;
                    document.getElementById('colaboradorEmpresa').value = colab.empresa;
                }
            } else {
                document.getElementById('colaboradorModalTitle').textContent = 'Novo Colaborador';
                document.getElementById('colaboradorId').value = '';
                document.getElementById('colaboradorForm').reset();
            }
            loadSelects();
        }

        function showLancamentoModal() {
            document.getElementById('lancamentoModal').style.display = 'block';
            loadColaboradoresSelect();
        }

        function showEmpresaModal() {
            document.getElementById('empresaModal').style.display = 'block';
        }

        function showDepartamentoModal() {
            document.getElementById('departamentoModal').style.display = 'block';
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'colaboradorModal') {
                document.getElementById('colaboradorForm').reset();
            } else if (modalId === 'lancamentoModal') {
                document.getElementById('lancamentoForm').reset();
            } else if (modalId === 'empresaModal') {
                document.getElementById('empresaForm').reset();
            } else if (modalId === 'departamentoModal') {
                document.getElementById('departamentoForm').reset();
            } else if (modalId === 'importModal') {
                document.getElementById('importForm').reset();
                document.getElementById('importAlert').classList.add('hidden');
            }
        }

        // Carregar dados do Firebase
        async function loadData() {
            showLoading(true);
            try {
                // Carregar colaboradores
                const colaboradoresSnapshot = await db.collection('colaboradores').get();
                colaboradores = colaboradoresSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Carregar lançamentos
                const lancamentosSnapshot = await db.collection('lancamentos').orderBy('data', 'desc').get();
                lancamentos = lancamentosSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Carregar empresas
                const empresasSnapshot = await db.collection('empresas').get();
                empresas = empresasSnapshot.docs.map(doc => doc.data().nome);

                // Carregar departamentos
                const departamentosSnapshot = await db.collection('departamentos').get();
                departamentos = departamentosSnapshot.docs.map(doc => doc.data().nome);

                updateAllTables();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados do Firebase!');
            }
            showLoading(false);
        }

        // Carregar selects
        function loadSelects() {
            const deptoSelect = document.getElementById('colaboradorDepartamento');
            const empresaSelect = document.getElementById('colaboradorEmpresa');
            
            deptoSelect.innerHTML = '<option value="">Selecione...</option>';
            empresaSelect.innerHTML = '<option value="">Selecione...</option>';
            
            departamentos.forEach(depto => {
                deptoSelect.innerHTML += `<option value="${depto}">${depto}</option>`;
            });
            
            empresas.forEach(empresa => {
                empresaSelect.innerHTML += `<option value="${empresa}">${empresa}</option>`;
            });
        }

        function loadColaboradoresSelect() {
            const select = document.getElementById('lancamentoColaborador');
            select.innerHTML = '<option value="">Selecione...</option>';
            colaboradores.forEach(colab => {
                select.innerHTML += `<option value="${colab.id}">${colab.nome}</option>`;
            });
        }

        // Validar data
        function isValidDate(dateStr) {
            const regex = /^\d{2}\/\d{2}\/\d{4}$/;
            if (!regex.test(dateStr)) return false;
            
            const [day, month, year] = dateStr.split('/').map(Number);
            const date = new Date(year, month - 1, day);
            return date.getDate() === day && date.getMonth() === month - 1 && date.getFullYear() === year;
        }

        // Salvar colaborador
        async function saveColaborador() {
            const id = document.getElementById('colaboradorId').value;
            const nome = document.getElementById('colaboradorNome').value;
            const data = document.getElementById('colaboradorData').value;
            const departamento = document.getElementById('colaboradorDepartamento').value;
            const empresa = document.getElementById('colaboradorEmpresa').value;

            if (!isValidDate(data)) {
                alert('Data inválida! Use o formato DD/MM/AAAA');
                return;
            }

            showLoading(true);
            try {
                const colaboradorData = {
                    nome,
                    dataAdmissao: data,
                    departamento,
                    empresa,
                    horasPositivas: 0,
                    horasNegativas: 0,
                    updatedAt: new Date().toISOString()
                };

                if (id) {
                    await db.collection('colaboradores').doc(id).update(colaboradorData);
                } else {
                    colaboradorData.createdAt = new Date().toISOString();
                    await db.collection('colaboradores').add(colaboradorData);
                }

                await loadData();
                hideModal('colaboradorModal');
            } catch (error) {
                console.error('Erro ao salvar colaborador:', error);
                alert('Erro ao salvar no Firebase!');
            }
            showLoading(false);
        }

        // Salvar lançamento
        async function saveLancamento() {
            const colaboradorId = document.getElementById('lancamentoColaborador').value;
            const data = document.getElementById('lancamentoData').value;
            const tipo = document.getElementById('lancamentoTipo').value;
            const horas = parseFloat(document.getElementById('lancamentoHoras').value);
            const descricao = document.getElementById('lancamentoDescricao').value;

            if (!colaboradorId || !isValidDate(data) || !horas) {
                alert('Preencha todos os campos corretamente!');
                return;
            }

            showLoading(true);
            try {
                // Salvar lançamento
                const lancamentoData = {
                    colaboradorId,
                    colaboradorNome: colaboradores.find(c => c.id === colaboradorId).nome,
                    data,
                    tipo,
                    horas,
                    descricao,
                    createdAt: new Date().toISOString()
                };

                await db.collection('lancamentos').add(lancamentoData);

                // Atualizar saldo do colaborador
                const colaborador = colaboradores.find(c => c.id === colaboradorId);
                const campo = tipo === 'positiva' ? 'horasPositivas' : 'horasNegativas';
                const novoValor = (colaborador[campo] || 0) + horas;

                await db.collection('colaboradores').doc(colaboradorId).update({
                    [campo]: novoValor,
                    updatedAt: new Date().toISOString()
                });

                await loadData();
                hideModal('lancamentoModal');
            } catch (error) {
                console.error('Erro ao salvar lançamento:', error);
                alert('Erro ao salvar no Firebase!');
            }
            showLoading(false);
        }

        // Salvar empresa
        async function saveEmpresa() {
            const nome = document.getElementById('empresaNome').value;
            if (nome && !empresas.includes(nome)) {
                showLoading(true);
                try {
                    await db.collection('empresas').add({ 
                        nome,
                        createdAt: new Date().toISOString()
                    });
                    await loadData();
                    hideModal('empresaModal');
                } catch (error) {
                    console.error('Erro ao salvar empresa:', error);
                    alert('Erro ao salvar no Firebase!');
                }
                showLoading(false);
            }
        }

        // Salvar departamento
        async function saveDepartamento() {
            const nome = document.getElementById('departamentoNome').value;
            if (nome && !departamentos.includes(nome)) {
                showLoading(true);
                try {
                    await db.collection('departamentos').add({ 
                        nome,
                        createdAt: new Date().toISOString()
                    });
                    await loadData();
                    hideModal('departamentoModal');
                } catch (error) {
                    console.error('Erro ao salvar departamento:', error);
                    alert('Erro ao salvar no Firebase!');
                }
                showLoading(false);
            }
        }

        // Importar colaboradores
        async function importColaboradores() {
            const data = document.getElementById('importData').value;
            const lines = data.split('\n');
            let imported = 0;
            let errors = 0;

            showLoading(true);
            try {
                for (const line of lines) {
                    if (line.trim()) {
                        const [nome, dataAdmissao, departamento, empresa] = line.split(',').map(item => item.trim());
                        
                        if (nome && dataAdmissao && departamento && empresa && isValidDate(dataAdmissao)) {
                            await db.collection('colaboradores').add({
                                nome,
                                dataAdmissao,
                                departamento,
                                empresa,
                                horasPositivas: 0,
                                horasNegativas: 0,
                                createdAt: new Date().toISOString()
                            });
                            imported++;
                        } else {
                            errors++;
                        }
                    }
                }

                await loadData();

                const alert = document.getElementById('importAlert');
                alert.textContent = `Importação concluída! ${imported} colaborador(es) importado(s) com sucesso.${errors > 0 ? ` ${errors} linha(s) com erro.` : ''}`;
                alert.className = 'alert alert-success';
                alert.classList.remove('hidden');

                setTimeout(() => {
                    hideModal('importModal');
                }, 2000);
            } catch (error) {
                console.error('Erro ao importar:', error);
                alert('Erro ao importar para o Firebase!');
            }
            showLoading(false);
        }

        // Deletar funções
        async function deleteColaborador(id) {
            if (confirm('Tem certeza que deseja excluir este colaborador?')) {
                showLoading(true);
                try {
                    await db.collection('colaboradores').doc(id).delete();
                    await loadData();
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    alert('Erro ao deletar do Firebase!');
                }
                showLoading(false);
            }
        }

        async function deleteEmpresa(index) {
            if (confirm('Tem certeza que deseja excluir esta empresa?')) {
                showLoading(true);
                try {
                    const snapshot = await db.collection('empresas').where('nome', '==', empresas[index]).get();
                    snapshot.forEach(async (doc) => {
                        await doc.ref.delete();
                    });
                    await loadData();
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    alert('Erro ao deletar do Firebase!');
                }
                showLoading(false);
            }
        }

        async function deleteDepartamento(index) {
            if (confirm('Tem certeza que deseja excluir este departamento?')) {
                showLoading(true);
                try {
                    const snapshot = await db.collection('departamentos').where('nome', '==', departamentos[index]).get();
                    snapshot.forEach(async (doc) => {
                        await doc.ref.delete();
                    });
                    await loadData();
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    alert('Erro ao deletar do Firebase!');
                }
                showLoading(false);
            }
        }

        async function deleteLancamento(id) {
            if (confirm('Tem certeza que deseja excluir este lançamento?')) {
                showLoading(true);
                try {
                    const lancamento = lancamentos.find(l => l.id === id);
                    if (lancamento) {
                        // Atualizar saldo do colaborador
                        const colaborador = colaboradores.find(c => c.id === lancamento.colaboradorId);
                        if (colaborador) {
                            const campo = lancamento.tipo === 'positiva' ? 'horasPositivas' : 'horasNegativas';
                            const novoValor = (colaborador[campo] || 0) - lancamento.horas;
                            
                            await db.collection('colaboradores').doc(lancamento.colaboradorId).update({
                                [campo]: Math.max(0, novoValor),
                                updatedAt: new Date().toISOString()
                            });
                        }
                        
                        await db.collection('lancamentos').doc(id).delete();
                        await loadData();
                    }
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    alert('Erro ao deletar do Firebase!');
                }
                showLoading(false);
            }
        }

        // Atualizar todas as tabelas
        function updateAllTables() {
            updateColaboradoresTable();
            updateLancamentosTable();
            updateEmpresasTable();
            updateDepartamentosTable();
            updateDashboard();
            loadColaboradoresSelect();
        }

        function updateColaboradoresTable() {
            const tbody = document.getElementById('colaboradoresList');
            tbody.innerHTML = '';

            colaboradores.forEach(colab => {
                const saldo = (colab.horasPositivas || 0) - (colab.horasNegativas || 0);
                const statusClass = saldo >= 0 ? 'status-positive' : 'status-negative';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${colab.nome}</td>
                        <td>${colab.dataAdmissao}</td>
                        <td>${colab.departamento}</td>
                        <td>${colab.empresa}</td>
                        <td class="${statusClass}">${saldo} h</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-small" onclick="showColaboradorModal('${colab.id}')">Editar</button>
                                <button class="btn btn-danger btn-small" onclick="deleteColaborador('${colab.id}')">Excluir</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        function updateLancamentosTable() {
            const tbody = document.getElementById('lancamentosList');
            tbody.innerHTML = '';

            lancamentos.slice(0, 20).forEach(lanc => {
                const tipoClass = lanc.tipo === 'positiva' ? 'status-positive' : 'status-negative';
                const tipoText = lanc.tipo === 'positiva' ? 'Hora Extra' : 'Débito';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${lanc.colaboradorNome}</td>
                        <td>${lanc.data}</td>
                        <td class="${tipoClass}">${tipoText}</td>
                        <td>${lanc.horas} h</td>
                        <td>${lanc.descricao || '-'}</td>
                        <td>
                            <button class="btn btn-danger btn-small" onclick="deleteLancamento('${lanc.id}')">Excluir</button>
                        </td>
                    </tr>
                `;
            });
        }

        function updateEmpresasTable() {
            const tbody = document.getElementById('empresasList');
            tbody.innerHTML = '';

            empresas.forEach((empresa, index) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${empresa}</td>
                        <td>
                            <button class="btn btn-danger btn-small" onclick="deleteEmpresa(${index})">Excluir</button>
                        </td>
                    </tr>
                `;
            });
        }

        function updateDepartamentosTable() {
            const tbody = document.getElementById('departamentosList');
            tbody.innerHTML = '';

            departamentos.forEach((depto, index) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${depto}</td>
                        <td>
                            <button class="btn btn-danger btn-small" onclick="deleteDepartamento(${index})">Excluir</button>
                        </td>
                    </tr>
                `;
            });
        }

        // Atualizar Dashboard
        function updateDashboard() {
            document.getElementById('totalColaboradores').textContent = colaboradores.length;
            
            let totalPositivas = colaboradores.reduce((sum, colab) => sum + (colab.horasPositivas || 0), 0);
            let totalNegativas = colaboradores.reduce((sum, colab) => sum + (colab.horasNegativas || 0), 0);
            
            document.getElementById('totalHorasPositivas').textContent = totalPositivas;
            document.getElementById('totalHorasNegativas').textContent = totalNegativas;
            document.getElementById('saldoLiquido').textContent = totalPositivas - totalNegativas;

            // Atividades recentes
            const activities = document.getElementById('recentActivities');
            activities.innerHTML = lancamentos.slice(0, 10).map(lanc => `
                <div class="activity-item">
                    <span><strong>${lanc.colaboradorNome}</strong> - ${lanc.tipo === 'positiva' ? '+' : '-'}${lanc.horas}h</span>
                    <span>${lanc.data}</span>
                </div>
            `).join('');

            if (lancamentos.length === 0) {
                activities.innerHTML = '<div class="activity-item">Nenhum lançamento recente</div>';
            }
        }

        // Inicialização
        loadData();

        // Fechar modais ao clicar fora
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>