<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco de Horas - Sistema de Compensa√ß√£o</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: #f8fafc;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
            padding: 24px 0;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 0 24px;
            margin-bottom: 32px;
        }

        .sidebar-header h2 {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-left: 4px solid #3b82f6;
            padding-left: 16px;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            padding: 14px 24px;
            margin: 4px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .sidebar-nav li:hover {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }

        .sidebar-nav li.active {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 32px;
            background-color: #f8fafc;
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-header h1 {
            color: #0f172a;
            font-size: 1.875rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        /* Cards Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.blue { background: #dbeafe; color: #2563eb; }
        .stat-icon.green { background: #dcfce7; color: #16a34a; }
        .stat-icon.red { background: #fee2e2; color: #dc2626; }
        .stat-icon.purple { background: #f3e8ff; color: #9333ea; }

        .stat-title {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .stat-value {
            color: #0f172a;
            font-size: 2rem;
            font-weight: 700;
        }

        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Bot√µes */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }

        .btn-secondary {
            background-color: white;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background-color: #f8fafc;
            border-color: #cbd5e1;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 8px;
        }

        .btn-print {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
            margin-right: 12px;
        }

        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(71, 85, 105, 0.4);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 800px;
            margin: 40px auto;
            padding: 32px;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }

        .modal-content h2 {
            color: #0f172a;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 24px;
        }

        /* Formul√°rios */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #334155;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s;
            background-color: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Filtros */
        .filters-bar {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 8px;
            color: #475569;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            background: white;
            transition: all 0.2s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        /* Tabelas */
        .table-container {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 16px;
            color: #64748b;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            cursor: pointer;
            transition: color 0.2s;
        }

        th:hover {
            color: #3b82f6;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            color: #1e293b;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: #f8fafc;
        }

        /* Badges de status */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 40px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef9c3;
            color: #854d0e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-neutral {
            background: #f1f5f9;
            color: #334155;
        }

        .badge-purple {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .badge-compensada {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-quitado {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-vencida {
            background: #fee2e2;
            color: #991b1b;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        /* Tooltip para compensa√ß√µes */
        .compensacoes-tooltip {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted #64748b;
        }

        .compensacoes-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: pre-line;
            z-index: 1000;
            min-width: 200px;
            text-align: left;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .compensacoes-tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1e293b;
            margin-bottom: -5px;
            z-index: 1000;
        }

        /* Header com a√ß√µes */
        .header-with-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Resumo */
        .resumo-info {
            background: #f8fafc;
            border-radius: 16px;
            padding: 16px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 24px;
            border: 2px solid #e2e8f0;
        }

        .resumo-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .resumo-label {
            color: #64748b;
            font-weight: 500;
        }

        .resumo-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
        }

        .resumo-value.positivo { color: #16a34a; }
        .resumo-value.negativo { color: #dc2626; }

        /* Pagination */
        .pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        /* Bot√£o de recarregar */
        .btn-refresh {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            margin-left: 16px;
        }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .header-with-refresh {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        /* Alertas */
        .alert {
            padding: 16px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            font-weight: 500;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .alert-warning {
            background: #fef9c3;
            color: #854d0e;
            border: 1px solid #fde047;
        }

        .hidden {
            display: none;
        }

        /* Tabs */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* Estilos para impress√£o */
        @media print {
            .sidebar, .page-header, .filters-bar, .header-with-actions, 
            .btn, .action-buttons, .resumo-info, .modal, .loading-overlay,
            .compensacoes-tooltip:hover::after, .compensacoes-tooltip:hover::before {
                display: none !important;
            }

            .main-content {
                padding: 0;
                background: white;
            }

            .table-container {
                box-shadow: none;
                padding: 0;
            }

            table {
                font-size: 10pt;
            }

            th {
                background: #f1f5f9;
                color: black;
            }

            td, th {
                border: 1px solid #e2e8f0;
                padding: 8px;
            }

            .badge {
                border: 1px solid #64748b;
                background: white !important;
                color: black !important;
                font-weight: normal;
            }
        }

        /* Checkbox list */
        .checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
        }

        .checkbox-item:last-child {
            border-bottom: none;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 16px;
            cursor: pointer;
        }

        .checkbox-item .info {
            flex: 1;
        }

        .checkbox-item .competencia {
            font-weight: 600;
            color: #0f172a;
        }

        .checkbox-item .detalhes {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 4px;
        }

        .checkbox-item .badge {
            margin-left: 8px;
        }

        .checkbox-item.selected {
            background-color: #f0f9ff;
        }

        /* Campos de valor */
        .valor-input {
            position: relative;
        }

        .valor-input input {
            padding-left: 30px;
        }

        .valor-input::before {
            content: 'R$';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-weight: 600;
        }

        .resumo-pagamento {
            background: #f8fafc;
            border-radius: 16px;
            padding: 16px;
            margin-top: 20px;
        }

        .resumo-linha {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .resumo-linha:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: #0f172a;
        }

        /* Total vencido */
        .total-vencido {
            background: #fee2e2;
            border: 2px solid #dc2626;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-vencido span {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .total-vencido .valor {
            color: #dc2626;
            font-size: 1.5rem;
        }

        /* Estilo para horas vencidas (positivas e negativas) */
        .badge-vencida-positiva {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        
        .badge-vencida-negativa {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #dc2626;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>‚è∞ Banco de Horas</h2>
            </div>
            <ul class="sidebar-nav">
                <li class="active" onclick="showTab('dashboard')">
                    <span>üìä</span> Dashboard
                </li>
                <li onclick="showTab('colaboradores')">
                    <span>üë•</span> Colaboradores
                </li>
                <li onclick="showTab('lancamentos')">
                    <span>‚è±Ô∏è</span> Banco de Horas
                </li>
                <li onclick="showTab('quitacoes')">
                    <span>üí∞</span> Quita√ß√µes
                </li>
                <li onclick="showTab('configuracoes')">
                    <span>‚öôÔ∏è</span> Configura√ß√µes
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="page-header">
                <h1>Banco de Horas</h1>
                <div class="user-info">
                    <span>Admin</span>
                    <div class="user-avatar">A</div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon blue">üë•</div>
                            <div>
                                <div class="stat-title">Total Colaboradores</div>
                                <div class="stat-value" id="totalColaboradores">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon green">‚ûï</div>
                            <div>
                                <div class="stat-title">Horas Positivas</div>
                                <div class="stat-value" id="totalHorasPositivas">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon red">‚ûñ</div>
                            <div>
                                <div class="stat-title">Horas Negativas</div>
                                <div class="stat-value" id="totalHorasNegativas">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon purple">‚öñÔ∏è</div>
                            <div>
                                <div class="stat-title">Saldo L√≠quido</div>
                                <div class="stat-value" id="saldoLiquido">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="margin-bottom: 20px;">√öltimos Lan√ßamentos</h3>
                    <div id="recentActivities">
                        <!-- Atividades ser√£o inseridas aqui -->
                    </div>
                </div>
            </div>

            <!-- Colaboradores Tab -->
            <div id="colaboradores" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="color: #0f172a;">üë• Colaboradores</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="showImportModal()">
                            üì• Importar
                        </button>
                        <button class="btn btn-primary" onclick="showColaboradorModal()">
                            + Novo Colaborador
                        </button>
                    </div>
                </div>

                <div class="filters-bar">
                    <div class="filter-group">
                        <label>Buscar</label>
                        <input type="text" id="searchColaborador" placeholder="Nome, departamento ou empresa..." onkeyup="filterColaboradores()">
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filterStatus" onchange="filterColaboradores()">
                            <option value="ativos">Ativos</option>
                            <option value="todos">Todos</option>
                            <option value="inativos">Inativos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Departamento</label>
                        <select id="filterDepartamento" onchange="filterColaboradores()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Empresa</label>
                        <select id="filterEmpresa" onchange="filterColaboradores()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                </div>

                <div id="importAlert" class="alert hidden"></div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortColaboradores('nome')">Nome üìä</th>
                                <th onclick="sortColaboradores('dataAdmissao')">Admiss√£o üìä</th>
                                <th onclick="sortColaboradores('departamento')">Departamento üìä</th>
                                <th onclick="sortColaboradores('empresa')">Empresa üìä</th>
                                <th>Saldo</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="colaboradoresList">
                            <!-- Colaboradores ser√£o inseridos aqui -->
                        </tbody>
                    </table>

                    <div class="pagination" id="pagination">
                        <!-- Pagina√ß√£o -->
                    </div>
                </div>
            </div>

            <!-- LAN√áAMENTOS TAB -->
            <div id="lancamentos" class="tab-content">
                <!-- Header com a√ß√µes -->
                <div class="header-with-actions">
                    <h2 style="color: #0f172a;">‚è±Ô∏è Banco de Horas</h2>
                    <div class="header-actions">
                        <button class="btn btn-print" onclick="window.print()">
                            üñ®Ô∏è Imprimir
                        </button>
                        <button class="btn btn-primary" onclick="showNovoLancamentoModal()">
                            + Novo Lan√ßamento
                        </button>
                    </div>
                </div>

                <!-- Filtros Autom√°ticos -->
                <div class="filters-bar">
                    <div class="filter-group">
                        <label>Colaborador</label>
                        <select id="filtroColaborador" onchange="aplicarFiltros()">
                            <option value="">Todos os colaboradores</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Departamento</label>
                        <select id="filtroDepartamento" onchange="aplicarFiltros()">
                            <option value="">Todos os departamentos</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Status Colaborador</label>
                        <select id="filtroStatus" onchange="aplicarFiltros()">
                            <option value="todos">Todos</option>
                            <option value="ativos" selected>Ativos</option>
                            <option value="inativos">Inativos</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Compet√™ncia</label>
                        <div style="display: flex; gap: 8px;">
                            <select id="filtroMes" onchange="aplicarFiltros()">
                                <option value="">Todos</option>
                                <option value="01">Janeiro</option>
                                <option value="02">Fevereiro</option>
                                <option value="03">Mar√ßo</option>
                                <option value="04">Abril</option>
                                <option value="05">Maio</option>
                                <option value="06">Junho</option>
                                <option value="07">Julho</option>
                                <option value="08">Agosto</option>
                                <option value="09">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                            <select id="filtroAno" onchange="aplicarFiltros()">
                                <option value="">Todos</option>
                                <!-- Anos preenchidos via JS (2020-2030) -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Resumo do Saldo do Colaborador Selecionado -->
                <div id="resumoSaldoContainer" class="resumo-info" style="display: none;">
                    <div class="resumo-item">
                        <span class="resumo-label">Colaborador:</span>
                        <span class="resumo-value" id="resumoColaboradorNome">-</span>
                    </div>
                    <div class="resumo-item">
                        <span class="resumo-label">Saldo Total:</span>
                        <span class="resumo-value" id="resumoSaldoTotal">00:00</span>
                    </div>
                </div>

                <!-- Tabela de Hist√≥rico de Lan√ßamentos -->
                <div class="table-container">
                    <div class="header-with-refresh">
                        <h3 style="margin-bottom: 0;">üìã Hist√≥rico de Lan√ßamentos</h3>
                        <span id="contadorLancamentos" style="color: #64748b;">0 lan√ßamentos</span>
                    </div>
                    
                    <div id="semResultadosMsg" style="text-align: center; padding: 40px; color: #64748b; display: none;">
                        Nenhum lan√ßamento encontrado com os filtros selecionados.
                    </div>

                    <table id="lancamentosTable">
                        <thead>
                            <tr>
                                <th>Colaborador</th>
                                <th>Quantidade</th>
                                <th>Compet√™ncia</th>
                                <th>Vencimento</th>
                                <th>Status</th>
                                <th>Saldo Acumulado</th>
                                <th>Falta Compensar</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lancamentosList">
                            <!-- Lan√ßamentos ser√£o inseridos aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- QUITA√á√ïES TAB -->
            <div id="quitacoes" class="tab-content">
                <!-- Header com a√ß√µes -->
                <div class="header-with-actions">
                    <h2 style="color: #0f172a;">üí∞ Quita√ß√µes</h2>
                    <div class="header-actions">
                        <button class="btn btn-print" onclick="window.print()">
                            üñ®Ô∏è Imprimir
                        </button>
                        <button class="btn btn-primary" onclick="showNovaQuitacaoModal()">
                            + Nova Quita√ß√£o
                        </button>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="filters-bar">
                    <div class="filter-group">
                        <label>Colaborador</label>
                        <select id="filtroQuitacaoColaborador" onchange="aplicarFiltrosQuitacoes()">
                            <option value="">Todos os colaboradores</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Departamento</label>
                        <select id="filtroQuitacaoDepartamento" onchange="aplicarFiltrosQuitacoes()">
                            <option value="">Todos os departamentos</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filtroQuitacaoStatus" onchange="aplicarFiltrosQuitacoes()">
                            <option value="todas">Todas</option>
                            <option value="quitadas">Quitadas</option>
                            <option value="vencidas">Vencidas (a quitar)</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Compet√™ncia Vencimento</label>
                        <div style="display: flex; gap: 8px;">
                            <select id="filtroQuitacaoMes" onchange="aplicarFiltrosQuitacoes()">
                                <option value="">Todos</option>
                                <option value="01">Janeiro</option>
                                <option value="02">Fevereiro</option>
                                <option value="03">Mar√ßo</option>
                                <option value="04">Abril</option>
                                <option value="05">Maio</option>
                                <option value="06">Junho</option>
                                <option value="07">Julho</option>
                                <option value="08">Agosto</option>
                                <option value="09">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                            <select id="filtroQuitacaoAno" onchange="aplicarFiltrosQuitacoes()">
                                <option value="">Todos</option>
                                <!-- Anos preenchidos via JS (2020-2030) -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Total de Horas Vencidas (Resumo) -->
                <div id="totalVencidoContainer" class="total-vencido hidden">
                    <span>üí∞ Total de Horas Vencidas a Quitar:</span>
                    <span class="valor" id="totalHorasVencidas">00:00</span>
                </div>

                <!-- Tabela de Horas Vencidas (N√£o Quitadas) -->
                <div class="table-container" id="horasVencidasContainer">
                    <div class="header-with-refresh">
                        <h3 style="margin-bottom: 0;">‚ö†Ô∏è Horas Vencidas (Aguardando Quita√ß√£o)</h3>
                        <span id="contadorVencidas" style="color: #64748b;">0 horas vencidas</span>
                    </div>
                    
                    <div id="semVencidasMsg" style="text-align: center; padding: 40px; color: #64748b; display: none;">
                        Nenhuma hora vencida encontrada.
                    </div>

                    <table id="horasVencidasTable">
                        <thead>
                            <tr>
                                <th>Colaborador</th>
                                <th>Departamento</th>
                                <th>Compet√™ncia</th>
                                <th>Vencimento</th>
                                <th>Tipo</th>
                                <th>Horas</th>
                                <th>Dias Vencidos</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="horasVencidasList">
                            <!-- Horas vencidas ser√£o inseridas aqui -->
                        </tbody>
                    </table>
                </div>

                <!-- Tabela de Quita√ß√µes Realizadas -->
                <div class="table-container" style="margin-top: 24px;">
                    <div class="header-with-refresh">
                        <h3 style="margin-bottom: 0;">üìã Hist√≥rico de Quita√ß√µes</h3>
                        <span id="contadorQuitacoes" style="color: #64748b;">0 quita√ß√µes</span>
                    </div>
                    
                    <div id="semQuitacoesMsg" style="text-align: center; padding: 40px; color: #64748b; display: none;">
                        Nenhuma quita√ß√£o encontrada.
                    </div>

                    <table id="quitacoesTable">
                        <thead>
                            <tr>
                                <th>Funcion√°rio</th>
                                <th>Data da Quita√ß√£o</th>
                                <th>Compet√™ncia Pagamento</th>
                                <th>Tipo</th>
                                <th>Horas Quitadas</th>
                                <th>Valor (Folha)</th>
                                <th>Valor (Reflexo)</th>
                                <th>Total</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="quitacoesList">
                            <!-- Quita√ß√µes ser√£o inseridas aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Configura√ß√µes Tab -->
            <div id="configuracoes" class="tab-content">
                <h2 style="color: #0f172a; margin-bottom: 24px;">‚öôÔ∏è Configura√ß√µes</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <!-- Empresas -->
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Empresas</h3>
                            <button class="btn btn-primary" onclick="showEmpresaModal()">+ Nova</button>
                        </div>
                        <div id="empresasAlert" class="alert alert-info hidden">Nenhuma empresa cadastrada.</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th style="width: 100px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="empresasList"></tbody>
                        </table>
                    </div>

                    <!-- Departamentos -->
                    <div class="table-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3>Departamentos</h3>
                            <button class="btn btn-primary" onclick="showDepartamentoModal()">+ Novo</button>
                        </div>
                        <div id="departamentosAlert" class="alert alert-info hidden">Nenhum departamento cadastrado.</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th style="width: 100px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="departamentosList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Novo Lan√ßamento -->
    <div id="novoLancamentoModal" class="modal">
        <div class="modal-content">
            <h2>‚ûï Novo Lan√ßamento de Horas</h2>
            <form id="novoLancamentoForm" onsubmit="event.preventDefault(); salvarNovoLancamento();">
                <div class="form-group">
                    <label>Colaborador *</label>
                    <select id="novoLancamentoColaborador" required>
                        <option value="">Selecione um colaborador</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Tipo *</label>
                    <select id="novoLancamentoTipo" required>
                        <option value="positiva">‚ûï Horas Positivas (Extras)</option>
                        <option value="negativa">‚ûñ Horas Negativas (D√©bitos)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Quantidade (HH:MM) *</label>
                    <input type="text" id="novoLancamentoHoras" placeholder="00:00" value="00:00" required>
                </div>

                <div class="form-group">
                    <label>Compet√™ncia *</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="novoLancamentoMes" required style="flex: 1;">
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Mar√ßo</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                        <select id="novoLancamentoAno" required style="flex: 1;">
                            <!-- Anos preenchidos via JS (2020-2030) -->
                        </select>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('novoLancamentoModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Lan√ßamento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Nova Quita√ß√£o -->
    <div id="novaQuitacaoModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <h2>üí∞ Nova Quita√ß√£o de Horas Vencidas</h2>
            <form id="novaQuitacaoForm" onsubmit="event.preventDefault(); salvarNovaQuitacao();">
                <div class="form-row">
                    <div class="form-group">
                        <label>Funcion√°rio *</label>
                        <select id="quitacaoColaborador" required onchange="carregarHorasVencidasColaborador()">
                            <option value="">Selecione um funcion√°rio</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Departamento</label>
                        <input type="text" id="quitacaoDepartamento" readonly disabled style="background-color: #f1f5f9;">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Compet√™ncia de Pagamento *</label>
                        <div style="display: flex; gap: 8px;">
                            <select id="quitacaoMesPagamento" required style="flex: 1;">
                                <option value="01">Janeiro</option>
                                <option value="02">Fevereiro</option>
                                <option value="03">Mar√ßo</option>
                                <option value="04">Abril</option>
                                <option value="05">Maio</option>
                                <option value="06">Junho</option>
                                <option value="07">Julho</option>
                                <option value="08">Agosto</option>
                                <option value="09">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                            <select id="quitacaoAnoPagamento" required style="flex: 1;">
                                <!-- Anos preenchidos via JS (2020-2030) -->
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Data da Quita√ß√£o *</label>
                        <input type="date" id="quitacaoData" required value="">
                    </div>
                </div>

                <div style="margin: 24px 0;">
                    <h3 style="margin-bottom: 16px;">üìã Horas Vencidas Dispon√≠veis para Quita√ß√£o</h3>
                    
                    <div class="checkbox-list" id="lancamentosDisponiveisList">
                        <!-- Lan√ßamentos ser√£o inseridos aqui -->
                    </div>

                    <div id="totalHorasSelecionadas" style="margin-top: 12px; text-align: right; font-weight: 600; color: #0f172a;">
                        Horas selecionadas: 00:00 de 00:00 dispon√≠veis
                    </div>
                </div>

                <div style="display: flex; gap: 24px; margin: 24px 0;">
                    <div class="form-group" style="flex: 1;">
                        <label>Valor por Hora (R$) *</label>
                        <input type="number" id="quitacaoValorHora" step="0.01" min="0" required onchange="calcularValoresQuitacao()">
                    </div>

                    <div class="form-group" style="flex: 1;">
                        <label>Valor de Reflexo (R$)</label>
                        <input type="number" id="quitacaoValorReflexo" step="0.01" min="0" value="0.00" onchange="calcularValoresQuitacao()">
                    </div>
                </div>

                <div class="resumo-pagamento">
                    <div class="resumo-linha">
                        <span>Total Horas:</span>
                        <span id="resumoTotalHoras">00:00</span>
                    </div>
                    <div class="resumo-linha">
                        <span>Valor Horas:</span>
                        <span>R$ <span id="resumoValorHoras">0,00</span></span>
                    </div>
                    <div class="resumo-linha">
                        <span>Valor de Reflexo:</span>
                        <span>R$ <span id="resumoValorReflexo">0,00</span></span>
                    </div>
                    <div class="resumo-linha">
                        <span>Total Pago:</span>
                        <span>R$ <span id="resumoTotalPago">0,00</span></span>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('novaQuitacaoModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Quita√ß√£o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Visualiza√ß√£o de Quita√ß√£o -->
    <div id="visualizarQuitacaoModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2>Detalhes da Quita√ß√£o</h2>
            <div id="detalhesQuitacao" style="margin-bottom: 24px;">
                <!-- Detalhes ser√£o inseridos aqui -->
            </div>
            <div id="lancamentosQuitadosList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Lan√ßamentos quitados ser√£o inseridos aqui -->
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" class="btn btn-secondary" onclick="hideModal('visualizarQuitacaoModal')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modais existentes -->
    <div id="colaboradorModal" class="modal">
        <div class="modal-content">
            <h2 id="colaboradorModalTitle">Novo Colaborador</h2>
            <form id="colaboradorForm" onsubmit="event.preventDefault(); saveColaborador();">
                <input type="hidden" id="colaboradorId">
                <div class="form-group">
                    <label>Nome Completo:</label>
                    <input type="text" id="colaboradorNome" required>
                </div>
                <div class="form-group">
                    <label>Data de Admiss√£o:</label>
                    <input type="text" id="colaboradorData" placeholder="DD/MM/AAAA" required>
                </div>
                <div class="form-group">
                    <label>Departamento:</label>
                    <select id="colaboradorDepartamento" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Empresa:</label>
                    <select id="colaboradorEmpresa" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                    <input type="checkbox" id="colaboradorAtivo" checked style="width: 18px; height: 18px;">
                    <label for="colaboradorAtivo" style="color: #334155;">Colaborador Ativo</label>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('colaboradorModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editLancamentoModal" class="modal">
        <div class="modal-content">
            <h2>Editar Lan√ßamento</h2>
            <form id="editLancamentoForm" onsubmit="event.preventDefault(); updateLancamento();">
                <input type="hidden" id="editLancamentoId">
                <div class="form-group">
                    <label>Colaborador:</label>
                    <select id="editLancamentoColaborador" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tipo:</label>
                    <select id="editLancamentoTipo" required>
                        <option value="positiva">‚ûï Horas Positivas (Extras)</option>
                        <option value="negativa">‚ûñ Horas Negativas (D√©bitos)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantidade (HH:MM):</label>
                    <input type="text" id="editLancamentoHoras" placeholder="00:00" value="00:00" required>
                </div>
                <div class="form-group">
                    <label>Compet√™ncia:</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="editLancamentoMes" required>
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Mar√ßo</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                        <select id="editLancamentoAno" required>
                            <!-- Anos preenchidos via JS (2020-2030) -->
                        </select>
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('editLancamentoModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Atualizar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="visualizarCompensacoesModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h2>Detalhes das Compensa√ß√µes</h2>
            <div id="compensacoesList" style="max-height: 400px; overflow-y: auto;">
                <!-- Compensa√ß√µes ser√£o inseridas aqui -->
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="hideModal('visualizarCompensacoesModal')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="empresaModal" class="modal">
        <div class="modal-content">
            <h2 id="empresaModalTitle">Nova Empresa</h2>
            <form id="empresaForm" onsubmit="event.preventDefault(); saveEmpresa();">
                <input type="hidden" id="empresaId">
                <input type="hidden" id="empresaNomeOriginal">
                <div class="form-group">
                    <label>Nome da Empresa:</label>
                    <input type="text" id="empresaNome" required>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('empresaModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="departamentoModal" class="modal">
        <div class="modal-content">
            <h2 id="departamentoModalTitle">Novo Departamento</h2>
            <form id="departamentoForm" onsubmit="event.preventDefault(); saveDepartamento();">
                <input type="hidden" id="departamentoId">
                <input type="hidden" id="departamentoNomeOriginal">
                <div class="form-group">
                    <label>Nome do Departamento:</label>
                    <input type="text" id="departamentoNome" required>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('departamentoModal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <h2>Importar Planilha</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: #f8fafc; border-radius: 16px; padding: 16px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 8px;">üìã Modelo da Planilha</h4>
                    <p style="font-size: 0.9rem; color: #475569;">Formato: Nome, Data Admiss√£o (DD/MM/AAAA), Departamento, Empresa</p>
                    <pre style="background: white; padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 0.85rem;">
Jo√£o Silva,01/01/2023,TI,Empresa A
Maria Santos,15/03/2023,RH,Empresa B</pre>
                </div>
                
                <div class="form-group">
                    <label>Cole os dados:</label>
                    <textarea id="importData" rows="6" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px;"></textarea>
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button type="button" class="btn btn-secondary" onclick="hideModal('importModal')">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="importColaboradores()">Importar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDY6qtn4JJPXggiswJjUZCt866oycv_LHk",
            authDomain: "gestao-de-banco-de-horas.firebaseapp.com",
            projectId: "gestao-de-banco-de-horas",
            storageBucket: "gestao-de-banco-de-horas.firebasestorage.app",
            messagingSenderId: "1071713106694",
            appId: "1:1071713106694:web:0a164293419ba46b6e7c87"
        };

        // Initialize Firebase
        let app;
        let db;
        let firebaseConnected = false;

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            const settings = { timestampsInSnapshots: true };
            db.settings(settings);
            
            // Testar conex√£o
            db.collection('test').limit(1).get()
                .then(() => {
                    console.log('Firebase conectado com sucesso!');
                    firebaseConnected = true;
                    loadData();
                })
                .catch((error) => {
                    console.error('Erro ao testar conex√£o:', error);
                    firebaseConnected = false;
                    alert('Erro ao conectar com Firebase. Verifique sua conex√£o.');
                });
        } catch (error) {
            console.error('Erro ao inicializar Firebase:', error);
            firebaseConnected = false;
        }

        // Vari√°veis globais
        let colaboradores = [];
        let lancamentos = [];
        let quitacoes = [];
        let empresas = [];
        let empresasDocs = [];
        let departamentos = [];
        let departamentosDocs = [];
        
        let colaboradoresFiltrados = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let sortField = 'nome';
        let sortDirection = 'asc';

        // Fun√ß√µes utilit√°rias
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.sidebar-nav li').forEach((item, index) => {
                item.classList.remove('active');
                if ((tabName === 'dashboard' && index === 0) ||
                    (tabName === 'colaboradores' && index === 1) ||
                    (tabName === 'lancamentos' && index === 2) ||
                    (tabName === 'quitacoes' && index === 3) ||
                    (tabName === 'configuracoes' && index === 4)) {
                    item.classList.add('active');
                }
            });
            
            if (tabName === 'lancamentos') {
                carregarFiltros();
                aplicarFiltros();
            } else if (tabName === 'quitacoes') {
                carregarFiltrosQuitacoes();
                aplicarFiltrosQuitacoes();
                renderizarHorasVencidas();
            }
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showNovoLancamentoModal() {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase.');
                return;
            }
            
            if (colaboradores.length === 0) {
                alert('Cadastre colaboradores primeiro!');
                showTab('colaboradores');
                return;
            }
            
            // Carregar colaboradores no select
            const select = document.getElementById('novoLancamentoColaborador');
            select.innerHTML = '<option value="">Selecione um colaborador</option>';
            colaboradores.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(colab => {
                const status = colab.ativo !== false ? '' : ' (Inativo)';
                select.innerHTML += `<option value="${colab.id}">${colab.nome}${status}</option>`;
            });
            
            // Preencher anos
            const anoSelect = document.getElementById('novoLancamentoAno');
            anoSelect.innerHTML = '';
            for (let i = 2020; i <= 2030; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === new Date().getFullYear()) option.selected = true;
                anoSelect.appendChild(option);
            }
            
            // Resetar formul√°rio
            document.getElementById('novoLancamentoForm').reset();
            document.getElementById('novoLancamentoHoras').value = '00:00';
            
            document.getElementById('novoLancamentoModal').style.display = 'block';
        }

        async function salvarNovoLancamento() {
            const colaboradorId = document.getElementById('novoLancamentoColaborador').value;
            const tipo = document.getElementById('novoLancamentoTipo').value;
            const horaStr = document.getElementById('novoLancamentoHoras').value;
            const mes = document.getElementById('novoLancamentoMes').value;
            const ano = document.getElementById('novoLancamentoAno').value;

            if (!colaboradorId || !tipo || !horaStr || !mes || !ano) {
                alert('Preencha todos os campos obrigat√≥rios!');
                return;
            }

            if (!isValidHora(horaStr)) {
                alert('Formato de hora inv√°lido! Use HH:MM (ex: 08:30)');
                return;
            }

            const horas = horaParaDecimal(horaStr);
            if (horas < 0) {
                alert('A quantidade de horas n√£o pode ser negativa!');
                return;
            }

            const colaborador = colaboradores.find(c => c.id === colaboradorId);
            if (!colaborador) {
                alert('Colaborador n√£o encontrado!');
                return;
            }

            const data = `01/${mes}/${ano}`;

            showLoading(true);
            
            try {
                const lancamentoData = {
                    colaboradorId: colaboradorId,
                    colaboradorNome: colaborador.nome || '',
                    colaboradorDepartamento: colaborador.departamento || '',
                    data: data,
                    mes: mes,
                    ano: ano,
                    tipo: tipo,
                    horas: horas,
                    saldoRestante: horas,
                    compensacoes: [],
                    compensadoPor: [],
                    quitado: false,
                    quitadoEm: null,
                    quitacaoId: null,
                    createdAt: new Date().toISOString()
                };

                await db.collection('lancamentos').add(lancamentoData);
                
                await loadData();
                
                hideModal('novoLancamentoModal');
                aplicarFiltros();
                alert('Lan√ßamento realizado com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar lan√ßamento:', error);
                alert('Erro ao salvar: ' + error.message);
            }
            showLoading(false);
        }

        function recarregarDados() {
            if (firebaseConnected) {
                loadData();
            } else {
                alert('Sem conex√£o com o Firebase.');
            }
        }

        // Fun√ß√µes para modais
        function showColaboradorModal(editId = null) {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase.');
                return;
            }
            
            if (empresas.length === 0 || departamentos.length === 0) {
                alert('Cadastre empresas e departamentos primeiro!');
                showTab('configuracoes');
                return;
            }
            
            loadSelects();
            document.getElementById('colaboradorModal').style.display = 'block';
            
            if (editId) {
                document.getElementById('colaboradorModalTitle').textContent = 'Editar Colaborador';
                const colab = colaboradores.find(c => c.id === editId);
                if (colab) {
                    document.getElementById('colaboradorId').value = colab.id;
                    document.getElementById('colaboradorNome').value = colab.nome;
                    document.getElementById('colaboradorData').value = colab.dataAdmissao;
                    document.getElementById('colaboradorDepartamento').value = colab.departamento;
                    document.getElementById('colaboradorEmpresa').value = colab.empresa;
                    document.getElementById('colaboradorAtivo').checked = colab.ativo !== false;
                }
            } else {
                document.getElementById('colaboradorModalTitle').textContent = 'Novo Colaborador';
                document.getElementById('colaboradorId').value = '';
                document.getElementById('colaboradorForm').reset();
                document.getElementById('colaboradorAtivo').checked = true;
            }
        }

        function showEditLancamentoModal(id) {
            const lanc = lancamentos.find(l => l.id === id);
            if (!lanc) return;

            // Carregar colaboradores no select
            const select = document.getElementById('editLancamentoColaborador');
            select.innerHTML = '<option value="">Selecione...</option>';
            colaboradores.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(colab => {
                const status = colab.ativo !== false ? '' : ' (Inativo)';
                select.innerHTML += `<option value="${colab.id}">${colab.nome}${status}</option>`;
            });

            // Preencher dados
            document.getElementById('editLancamentoId').value = lanc.id;
            document.getElementById('editLancamentoColaborador').value = lanc.colaboradorId;
            document.getElementById('editLancamentoTipo').value = lanc.tipo;
            
            // Converter horas decimais para HH:MM
            const horas = Math.floor(Math.abs(lanc.horas));
            const minutos = Math.round((Math.abs(lanc.horas) - horas) * 60);
            document.getElementById('editLancamentoHoras').value = `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
            
            // Extrair m√™s e ano da data (DD/MM/AAAA)
            const [dia, mes, ano] = lanc.data.split('/');
            document.getElementById('editLancamentoMes').value = mes;
            document.getElementById('editLancamentoAno').value = ano;

            document.getElementById('editLancamentoModal').style.display = 'block';
        }

        function showVisualizarCompensacoesModal(lancamentoId) {
            const lanc = lancamentos.find(l => l.id === lancamentoId);
            if (!lanc || (!lanc.compensacoes || lanc.compensacoes.length === 0) && (!lanc.compensadoPor || lanc.compensadoPor.length === 0)) {
                alert('Este lan√ßamento n√£o possui compensa√ß√µes registradas.');
                return;
            }

            const colaborador = colaboradores.find(c => c.id === lanc.colaboradorId);
            const container = document.getElementById('compensacoesList');
            
            let html = `
                <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 12px;">
                    <strong>Lan√ßamento:</strong> ${decimalParaHora(lanc.horas)} ${lanc.tipo === 'positiva' ? '‚ûï' : '‚ûñ'}<br>
                    <strong>Compet√™ncia:</strong> ${formatarCompetencia(lanc.mes, lanc.ano)}<br>
                    <strong>Colaborador:</strong> ${colaborador ? colaborador.nome : 'N/A'}
                </div>
            `;

            // Compensa√ß√µes que este lan√ßamento fez em outros
            if (lanc.compensacoes && lanc.compensacoes.length > 0) {
                html += '<h4 style="margin-bottom: 16px;">Compensou outros lan√ßamentos:</h4>';
                lanc.compensacoes.forEach(comp => {
                    const lancComp = lancamentos.find(l => l.id === comp.lancamentoId);
                    if (lancComp) {
                        html += `
                            <div style="padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px;">
                                <strong>${formatarCompetencia(lancComp.mes, lancComp.ano)}</strong> (${lancComp.tipo === 'positiva' ? '‚ûï' : '‚ûñ'})<br>
                                Quantidade compensada: ${decimalParaHora(comp.quantidade)}<br>
                                Data: ${comp.data || 'N/A'}
                            </div>
                        `;
                    }
                });
            }

            // Lan√ßamentos que compensaram este
            if (lanc.compensadoPor && lanc.compensadoPor.length > 0) {
                html += '<h4 style="margin-bottom: 16px; margin-top: 20px;">Foi compensado por:</h4>';
                lanc.compensadoPor.forEach(comp => {
                    const lancComp = lancamentos.find(l => l.id === comp.lancamentoId);
                    if (lancComp) {
                        html += `
                            <div style="padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px;">
                                <strong>${formatarCompetencia(lancComp.mes, lancComp.ano)}</strong> (${lancComp.tipo === 'positiva' ? '‚ûï' : '‚ûñ'})<br>
                                Quantidade: ${decimalParaHora(comp.quantidade)}<br>
                                Data: ${comp.data || 'N/A'}
                            </div>
                        `;
                    }
                });
            }

            container.innerHTML = html;
            document.getElementById('visualizarCompensacoesModal').style.display = 'block';
        }

        function showEmpresaModal(editNome = null) {
            document.getElementById('empresaModal').style.display = 'block';
            if (editNome) {
                document.getElementById('empresaModalTitle').textContent = 'Editar Empresa';
                document.getElementById('empresaNome').value = editNome;
                document.getElementById('empresaNomeOriginal').value = editNome;
                const empresaDoc = empresasDocs.find(doc => doc.nome === editNome);
                if (empresaDoc) {
                    document.getElementById('empresaId').value = empresaDoc.id;
                }
            } else {
                document.getElementById('empresaModalTitle').textContent = 'Nova Empresa';
                document.getElementById('empresaId').value = '';
                document.getElementById('empresaNomeOriginal').value = '';
                document.getElementById('empresaNome').value = '';
            }
        }

        function showDepartamentoModal(editNome = null) {
            document.getElementById('departamentoModal').style.display = 'block';
            if (editNome) {
                document.getElementById('departamentoModalTitle').textContent = 'Editar Departamento';
                document.getElementById('departamentoNome').value = editNome;
                document.getElementById('departamentoNomeOriginal').value = editNome;
                const deptoDoc = departamentosDocs.find(doc => doc.nome === editNome);
                if (deptoDoc) {
                    document.getElementById('departamentoId').value = deptoDoc.id;
                }
            } else {
                document.getElementById('departamentoModalTitle').textContent = 'Novo Departamento';
                document.getElementById('departamentoId').value = '';
                document.getElementById('departamentoNomeOriginal').value = '';
                document.getElementById('departamentoNome').value = '';
            }
        }

        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }

        // Fun√ß√£o para verificar se uma hora est√° vencida (MESMA REGRA PARA POSITIVAS E NEGATIVAS)
        function isHoraVencida(mes, ano) {
            const hoje = new Date();
            
            // Data da compet√™ncia (primeiro dia do m√™s)
            const dataCompetencia = new Date(parseInt(ano), parseInt(mes) - 1, 1);
            
            // Data de vencimento √© 1 ano ap√≥s a compet√™ncia
            const dataVencimento = new Date(dataCompetencia);
            dataVencimento.setFullYear(dataVencimento.getFullYear() + 1);
            
            // Se hoje for maior ou igual √† data de vencimento, est√° vencida
            return hoje >= dataVencimento;
        }

        // Fun√ß√£o para calcular dias vencidos
        function calcularDiasVencidos(mes, ano) {
            const hoje = new Date();
            const dataCompetencia = new Date(parseInt(ano), parseInt(mes) - 1, 1);
            const dataVencimento = new Date(dataCompetencia);
            dataVencimento.setFullYear(dataVencimento.getFullYear() + 1);
            
            const diffTime = hoje - dataVencimento;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        }

        // Fun√ß√£o para mostrar modal de nova quita√ß√£o
        function showNovaQuitacaoModal() {
            if (!firebaseConnected) {
                alert('Sem conex√£o com o Firebase.');
                return;
            }
            
            if (colaboradores.length === 0) {
                alert('Cadastre colaboradores primeiro!');
                showTab('colaboradores');
                return;
            }

            // Preencher select de colaboradores
            const selectColab = document.getElementById('quitacaoColaborador');
            selectColab.innerHTML = '<option value="">Selecione um funcion√°rio</option>';
            colaboradores.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(colab => {
                const status = colab.ativo !== false ? '' : ' (Inativo)';
                selectColab.innerHTML += `<option value="${colab.id}">${colab.nome}${status}</option>`;
            });

            // Preencher anos
            const anoSelect = document.getElementById('quitacaoAnoPagamento');
            anoSelect.innerHTML = '';
            for (let i = 2020; i <= 2030; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === new Date().getFullYear()) option.selected = true;
                anoSelect.appendChild(option);
            }

            // Resetar formul√°rio
            document.getElementById('novaQuitacaoForm').reset();
            document.getElementById('quitacaoData').value = new Date().toISOString().split('T')[0];
            document.getElementById('quitacaoValorReflexo').value = '0.00';
            document.getElementById('quitacaoValorHora').value = '';
            document.getElementById('quitacaoDepartamento').value = '';
            document.getElementById('lancamentosDisponiveisList').innerHTML = '<div style="text-align: center; padding: 20px;">Selecione um colaborador</div>';
            document.getElementById('totalHorasSelecionadas').textContent = 'Horas selecionadas: 00:00 de 00:00 dispon√≠veis';
            
            calcularValoresQuitacao();

            document.getElementById('novaQuitacaoModal').style.display = 'block';
        }

        // Fun√ß√£o para carregar horas vencidas do colaborador (POSITIVAS E NEGATIVAS)
        function carregarHorasVencidasColaborador() {
            const colaboradorId = document.getElementById('quitacaoColaborador').value;
            
            if (!colaboradorId) {
                document.getElementById('quitacaoDepartamento').value = '';
                document.getElementById('lancamentosDisponiveisList').innerHTML = '<div style="text-align: center; padding: 20px;">Selecione um colaborador</div>';
                document.getElementById('totalHorasSelecionadas').textContent = 'Horas selecionadas: 00:00 de 00:00 dispon√≠veis';
                return;
            }

            const colaborador = colaboradores.find(c => c.id === colaboradorId);
            if (colaborador) {
                document.getElementById('quitacaoDepartamento').value = colaborador.departamento || '';
            }

            // Filtrar lan√ßamentos do colaborador que est√£o vencidos e n√£o quitados (AMBOS OS TIPOS)
            const lancamentosColab = lancamentos.filter(l => 
                l.colaboradorId === colaboradorId && 
                l.saldoRestante > 0 &&
                !l.quitado &&
                isHoraVencida(l.mes, l.ano)
            );

            if (lancamentosColab.length === 0) {
                document.getElementById('lancamentosDisponiveisList').innerHTML = '<div style="text-align: center; padding: 20px;">Nenhuma hora vencida dispon√≠vel para quita√ß√£o.</div>';
                document.getElementById('totalHorasSelecionadas').textContent = 'Horas selecionadas: 00:00 de 00:00 dispon√≠veis';
                return;
            }

            // Ordenar por data de vencimento (mais antigos primeiro)
            lancamentosColab.sort((a, b) => {
                return dataParaObjeto(a.data) - dataParaObjeto(b.data);
            });

            let html = '';
            lancamentosColab.forEach(lanc => {
                const competencia = formatarCompetencia(lanc.mes, lanc.ano);
                const vencimento = calcularVencimento(lanc.mes, lanc.ano);
                const diasVencidos = calcularDiasVencidos(lanc.mes, lanc.ano);
                const tipoLabel = lanc.tipo === 'positiva' ? '‚ûï Hora Extra (a receber)' : '‚ûñ Hora D√©bito (a pagar)';
                const badgeClass = lanc.tipo === 'positiva' ? 'badge-warning' : 'badge-danger';
                
                html += `
                    <div class="checkbox-item">
                        <input type="checkbox" class="lancamento-checkbox" 
                               value="${lanc.id}" 
                               data-horas="${lanc.saldoRestante}"
                               data-tipo="${lanc.tipo}"
                               onchange="atualizarTotalHorasSelecionadas()">
                        <div class="info">
                            <div>
                                <span class="competencia">${competencia}</span>
                                <span class="badge ${badgeClass}" style="margin-left: 8px;">${lanc.tipo === 'positiva' ? 'A RECEBER' : 'A PAGAR'}</span>
                                <span class="badge badge-danger" style="margin-left: 8px;">VENCIDA</span>
                            </div>
                            <div class="detalhes">
                                ${tipoLabel} - Dispon√≠vel: ${decimalParaHora(lanc.saldoRestante)} | 
                                Vencimento: ${vencimento} | 
                                Dias vencidos: ${diasVencidos}
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('lancamentosDisponiveisList').innerHTML = html;
            atualizarTotalHorasSelecionadas();
        }

        // Fun√ß√£o para atualizar total de horas selecionadas
        function atualizarTotalHorasSelecionadas() {
            const checkboxes = document.querySelectorAll('.lancamento-checkbox:checked');
            let totalSelecionado = 0;
            let totalDisponivel = 0;

            document.querySelectorAll('.lancamento-checkbox').forEach(cb => {
                if (cb.checked) {
                    totalSelecionado += parseFloat(cb.dataset.horas);
                }
                totalDisponivel += parseFloat(cb.dataset.horas);
            });

            document.getElementById('totalHorasSelecionadas').textContent = 
                `Horas selecionadas: ${decimalParaHora(totalSelecionado)} de ${decimalParaHora(totalDisponivel)} dispon√≠veis`;
            
            calcularValoresQuitacao();
        }

        // Fun√ß√£o para calcular valores da quita√ß√£o
        function calcularValoresQuitacao() {
            const checkboxes = document.querySelectorAll('.lancamento-checkbox:checked');
            let totalHoras = 0;
            checkboxes.forEach(cb => {
                totalHoras += parseFloat(cb.dataset.horas);
            });

            const valorHora = parseFloat(document.getElementById('quitacaoValorHora').value) || 0;
            const valorReflexo = parseFloat(document.getElementById('quitacaoValorReflexo').value) || 0;
            
            const valorHoras = totalHoras * valorHora;
            const total = valorHoras + valorReflexo;

            document.getElementById('resumoTotalHoras').textContent = decimalParaHora(totalHoras);
            document.getElementById('resumoValorHoras').textContent = valorHoras.toFixed(2).replace('.', ',');
            document.getElementById('resumoValorReflexo').textContent = valorReflexo.toFixed(2).replace('.', ',');
            document.getElementById('resumoTotalPago').textContent = total.toFixed(2).replace('.', ',');
        }

        // Fun√ß√£o para salvar nova quita√ß√£o
        async function salvarNovaQuitacao() {
            const colaboradorId = document.getElementById('quitacaoColaborador').value;
            const mesPagamento = document.getElementById('quitacaoMesPagamento').value;
            const anoPagamento = document.getElementById('quitacaoAnoPagamento').value;
            const dataQuitacao = document.getElementById('quitacaoData').value;
            const valorHora = parseFloat(document.getElementById('quitacaoValorHora').value) || 0;
            const valorReflexo = parseFloat(document.getElementById('quitacaoValorReflexo').value) || 0;

            // Validar campos obrigat√≥rios
            if (!colaboradorId || !mesPagamento || !anoPagamento || !dataQuitacao) {
                alert('Preencha todos os campos obrigat√≥rios!');
                return;
            }

            // Validar se pelo menos um lan√ßamento foi selecionado
            const checkboxes = document.querySelectorAll('.lancamento-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Selecione pelo menos uma hora vencida para quitar!');
                return;
            }

            // Validar valor da hora
            if (valorHora <= 0) {
                alert('O valor por hora deve ser maior que zero!');
                return;
            }

            const colaborador = colaboradores.find(c => c.id === colaboradorId);
            if (!colaborador) {
                alert('Colaborador n√£o encontrado!');
                return;
            }

            // Calcular total de horas selecionadas
            let totalHoras = 0;
            const lancamentosSelecionados = [];
            checkboxes.forEach(cb => {
                totalHoras += parseFloat(cb.dataset.horas);
                lancamentosSelecionados.push({
                    id: cb.value,
                    horas: parseFloat(cb.dataset.horas),
                    tipo: cb.dataset.tipo
                });
            });

            // Formatar compet√™ncia de pagamento
            const competenciaPagamento = `${mesPagamento}/${anoPagamento}`;

            showLoading(true);

            try {
                // Calcular valores
                const valorFolha = totalHoras * valorHora;
                const totalPago = valorFolha + valorReflexo;

                // Criar registro de quita√ß√£o
                const quitacaoData = {
                    colaboradorId: colaboradorId,
                    colaboradorNome: colaborador.nome,
                    colaboradorDepartamento: colaborador.departamento,
                    dataQuitacao: dataQuitacao,
                    competenciaPagamento: competenciaPagamento,
                    mesPagamento: mesPagamento,
                    anoPagamento: anoPagamento,
                    horasQuitadas: totalHoras,
                    valorHora: valorHora,
                    valorFolha: valorFolha,
                    valorReflexo: valorReflexo,
                    totalPago: totalPago,
                    lancamentos: lancamentosSelecionados,
                    createdAt: new Date().toISOString()
                };

                const quitacaoRef = await db.collection('quitacoes').add(quitacaoData);

                // Atualizar lan√ßamentos quitados
                for (const lanc of lancamentosSelecionados) {
                    await db.collection('lancamentos').doc(lanc.id).update({
                        quitado: true,
                        quitadoEm: dataQuitacao,
                        quitacaoId: quitacaoRef.id,
                        valorQuitacaoHora: valorHora,
                        valorQuitacaoTotal: lanc.horas * valorHora
                    });
                }

                await loadData();
                
                hideModal('novaQuitacaoModal');
                aplicarFiltrosQuitacoes();
                renderizarHorasVencidas();
                alert('Quita√ß√£o realizada com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar quita√ß√£o:', error);
                alert('Erro ao salvar: ' + error.message);
            }
            showLoading(false);
        }

        // Fun√ß√£o para visualizar detalhes da quita√ß√£o
        function showVisualizarQuitacaoModal(id) {
            const quitacao = quitacoes.find(q => q.id === id);
            if (!quitacao) return;

            const colaborador = colaboradores.find(c => c.id === quitacao.colaboradorId);
            
            const detalhes = document.getElementById('detalhesQuitacao');
            detalhes.innerHTML = `
                <div style="padding: 16px; background: #f8fafc; border-radius: 12px; margin-bottom: 20px;">
                    <p><strong>Colaborador:</strong> ${quitacao.colaboradorNome}</p>
                    <p><strong>Departamento:</strong> ${quitacao.colaboradorDepartamento || 'N/A'}</p>
                    <p><strong>Data da Quita√ß√£o:</strong> ${new Date(quitacao.dataQuitacao).toLocaleDateString('pt-BR')}</p>
                    <p><strong>Compet√™ncia Pagamento:</strong> ${quitacao.competenciaPagamento}</p>
                    <p><strong>Total Horas:</strong> ${decimalParaHora(quitacao.horasQuitadas)}</p>
                    <p><strong>Valor por Hora:</strong> R$ ${quitacao.valorHora.toFixed(2).replace('.', ',')}</p>
                    <p><strong>Valor na Folha:</strong> R$ ${quitacao.valorFolha.toFixed(2).replace('.', ',')}</p>
                    <p><strong>Valor de Reflexo:</strong> R$ ${quitacao.valorReflexo.toFixed(2).replace('.', ',')}</p>
                    <p><strong>Total Pago:</strong> R$ ${quitacao.totalPago.toFixed(2).replace('.', ',')}</p>
                </div>
            `;

            // Listar lan√ßamentos quitados
            const lancamentosQuitados = document.getElementById('lancamentosQuitadosList');
            let lancHtml = '<h4 style="margin-bottom: 16px;">Lan√ßamentos Quitados:</h4>';
            
            quitacao.lancamentos.forEach(lanc => {
                const lancOriginal = lancamentos.find(l => l.id === lanc.id);
                if (lancOriginal) {
                    const tipoLabel = lancOriginal.tipo === 'positiva' ? '‚ûï Hora Extra (a receber)' : '‚ûñ Hora D√©bito (a pagar)';
                    lancHtml += `
                        <div style="padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px;">
                            <strong>${formatarCompetencia(lancOriginal.mes, lancOriginal.ano)}</strong> - ${tipoLabel}<br>
                            Horas: ${decimalParaHora(lanc.horas)}
                        </div>
                    `;
                }
            });

            lancamentosQuitados.innerHTML = lancHtml;
            document.getElementById('visualizarQuitacaoModal').style.display = 'block';
        }

        // Fun√ß√£o para excluir quita√ß√£o
        async function deleteQuitacao(id) {
            if (!confirm('Tem certeza que deseja excluir esta quita√ß√£o? Isso reverter√° o status dos lan√ßamentos quitados.')) return;

            showLoading(true);
            try {
                const quitacao = quitacoes.find(q => q.id === id);
                if (!quitacao) return;

                // Reverter status dos lan√ßamentos
                for (const lanc of quitacao.lancamentos) {
                    await db.collection('lancamentos').doc(lanc.id).update({
                        quitado: false,
                        quitadoEm: null,
                        quitacaoId: null,
                        valorQuitacaoHora: null,
                        valorQuitacaoTotal: null
                    });
                }

                await db.collection('quitacoes').doc(id).delete();
                await loadData();
                aplicarFiltrosQuitacoes();
                renderizarHorasVencidas();
                alert('Quita√ß√£o exclu√≠da com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir quita√ß√£o:', error);
                alert('Erro ao excluir: ' + error.message);
            }
            showLoading(false);
        }

        // Fun√ß√£o para renderizar horas vencidas (POSITIVAS E NEGATIVAS)
        function renderizarHorasVencidas() {
            const horasVencidas = lancamentos.filter(l => 
                !l.quitado && 
                l.saldoRestante > 0 && 
                isHoraVencida(l.mes, l.ano)
            );

            const totalVencido = horasVencidas.reduce((sum, l) => sum + l.saldoRestante, 0);
            
            const totalVencidoContainer = document.getElementById('totalVencidoContainer');
            if (totalVencido > 0) {
                totalVencidoContainer.classList.remove('hidden');
                document.getElementById('totalHorasVencidas').textContent = decimalParaHora(totalVencido);
            } else {
                totalVencidoContainer.classList.add('hidden');
            }

            document.getElementById('contadorVencidas').textContent = `${decimalParaHora(totalVencido)} horas vencidas`;

            const tbody = document.getElementById('horasVencidasList');
            const tabela = document.getElementById('horasVencidasTable');
            const semVencidasMsg = document.getElementById('semVencidasMsg');

            if (horasVencidas.length === 0) {
                tabela.style.display = 'none';
                semVencidasMsg.style.display = 'block';
                return;
            }

            tabela.style.display = 'table';
            semVencidasMsg.style.display = 'none';

            tbody.innerHTML = '';

            horasVencidas.forEach(lanc => {
                const colaborador = colaboradores.find(c => c.id === lanc.colaboradorId);
                if (!colaborador) return;

                const competencia = formatarCompetencia(lanc.mes, lanc.ano);
                const vencimento = calcularVencimento(lanc.mes, lanc.ano);
                const diasVencidos = calcularDiasVencidos(lanc.mes, lanc.ano);
                
                const tipoLabel = lanc.tipo === 'positiva' ? '‚ûï Hora Extra (a receber)' : '‚ûñ Hora D√©bito (a pagar)';
                const badgeClass = lanc.tipo === 'positiva' ? 'badge-warning' : 'badge-danger';
                
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${colaborador.nome}</strong></td>
                        <td>${colaborador.departamento || 'N/A'}</td>
                        <td>${competencia}</td>
                        <td>${vencimento}</td>
                        <td><span class="badge ${badgeClass}">${tipoLabel}</span></td>
                        <td><span class="badge ${badgeClass}">${decimalParaHora(lanc.saldoRestante)}</span></td>
                        <td><span class="badge badge-danger">${diasVencidos} dias</span></td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="showNovaQuitacaoParaColaborador('${lanc.colaboradorId}')">
                                Quitar
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function showNovaQuitacaoParaColaborador(colaboradorId) {
            showNovaQuitacaoModal();
            
            // Aguardar o modal carregar e selecionar o colaborador
            setTimeout(() => {
                document.getElementById('quitacaoColaborador').value = colaboradorId;
                carregarHorasVencidasColaborador();
            }, 100);
        }

        // Fun√ß√µes de convers√£o de horas
        function horaParaDecimal(horaStr) {
            const [horas, minutos] = horaStr.split(':').map(Number);
            return horas + (minutos / 60);
        }

        function decimalParaHora(decimal) {
            if (decimal === undefined || decimal === null) return '00:00';
            const sinal = decimal < 0 ? '-' : '';
            const absDecimal = Math.abs(decimal);
            const horas = Math.floor(absDecimal);
            const minutos = Math.round((absDecimal - horas) * 60);
            return `${sinal}${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
        }

        function isValidHora(horaStr) {
            const regex = /^([0-9]{1,2}):([0-9]{2})$/;
            if (!regex.test(horaStr)) return false;
            const [horas, minutos] = horaStr.split(':').map(Number);
            return horas >= 0 && horas < 100 && minutos >= 0 && minutos < 60;
        }

        function isValidDate(dateStr) {
            const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            if (!regex.test(dateStr)) return false;
            const [_, dia, mes, ano] = dateStr.match(regex);
            const data = new Date(ano, mes - 1, dia);
            return data.getDate() == dia && data.getMonth() == mes - 1;
        }

        function formatarCompetencia(mes, ano) {
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            return `${meses[parseInt(mes) - 1]}/${ano}`;
        }

        // Fun√ß√£o para calcular vencimento (1 ano ap√≥s a compet√™ncia)
        function calcularVencimento(mes, ano) {
            const dataCompetencia = new Date(parseInt(ano), parseInt(mes) - 1, 1);
            const dataVencimento = new Date(dataCompetencia);
            dataVencimento.setFullYear(dataVencimento.getFullYear() + 1);
            
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            return `${meses[dataVencimento.getMonth()]}/${dataVencimento.getFullYear()}`;
        }

        // Fun√ß√£o para converter data string para objeto Date (usando primeiro dia do m√™s)
        function dataParaObjeto(dataStr) {
            const [dia, mes, ano] = dataStr.split('/');
            return new Date(parseInt(ano), parseInt(mes) - 1, 1);
        }

        // Fun√ß√£o para verificar se um positivo pode compensar um negativo (dentro do prazo de 1 ano)
        function podeCompensar(positivo, negativo) {
            // O positivo deve ser at√© 1 ano ap√≥s o negativo
            const dataNegativo = dataParaObjeto(negativo.data);
            const dataPositivo = dataParaObjeto(positivo.data);
            
            // Calcular data limite (negativo + 1 ano)
            const dataLimite = new Date(dataNegativo);
            dataLimite.setFullYear(dataLimite.getFullYear() + 1);
            
            // O positivo deve ser >= negativo e <= negativo + 1 ano
            return dataPositivo >= dataNegativo && dataPositivo <= dataLimite;
        }

        // Fun√ß√£o principal de compensa√ß√£o de horas
        function processarCompensacoes() {
            console.log('Iniciando processamento de compensa√ß√µes...');
            
            // Resetar saldos e compensa√ß√µes
            lancamentos.forEach(lanc => {
                if (!lanc.quitado) {
                    lanc.saldoRestante = lanc.horas;
                    lanc.compensacoes = [];
                    lanc.compensadoPor = [];
                }
            });
            
            // Agrupar lan√ßamentos por colaborador
            const lancamentosPorColaborador = {};
            lancamentos.forEach(lanc => {
                if (!lanc.quitado) {
                    if (!lancamentosPorColaborador[lanc.colaboradorId]) {
                        lancamentosPorColaborador[lanc.colaboradorId] = [];
                    }
                    lancamentosPorColaborador[lanc.colaboradorId].push(lanc);
                }
            });

            // Para cada colaborador, processar compensa√ß√µes
            Object.keys(lancamentosPorColaborador).forEach(colaboradorId => {
                const lancamentosColab = lancamentosPorColaborador[colaboradorId];
                
                // Ordenar todos os lan√ßamentos por data (mais antigos primeiro)
                lancamentosColab.sort((a, b) => {
                    return dataParaObjeto(a.data) - dataParaObjeto(b.data);
                });

                // Separar positivos e negativos
                const positivos = lancamentosColab.filter(l => l.tipo === 'positiva');
                const negativos = lancamentosColab.filter(l => l.tipo === 'negativa');

                // Para cada negativo, buscar positivos que podem compens√°-lo
                for (let i = 0; i < negativos.length; i++) {
                    const negativo = negativos[i];
                    if (negativo.saldoRestante <= 0) continue;
                    
                    // Encontrar positivos que podem compensar este negativo
                    const positivosViaveis = positivos.filter(p => 
                        p.saldoRestante > 0 && podeCompensar(p, negativo)
                    );
                    
                    // Ordenar positivos por data (mais antigos primeiro)
                    positivosViaveis.sort((a, b) => dataParaObjeto(a.data) - dataParaObjeto(b.data));
                    
                    for (let j = 0; j < positivosViaveis.length && negativo.saldoRestante > 0; j++) {
                        const positivo = positivosViaveis[j];
                        
                        const quantidadeCompensar = Math.min(positivo.saldoRestante, negativo.saldoRestante);
                        
                        if (quantidadeCompensar > 0) {
                            // Registrar compensa√ß√£o
                            negativo.compensadoPor.push({
                                lancamentoId: positivo.id,
                                quantidade: quantidadeCompensar,
                                data: new Date().toLocaleDateString('pt-BR')
                            });
                            
                            positivo.compensacoes.push({
                                lancamentoId: negativo.id,
                                quantidade: quantidadeCompensar,
                                data: new Date().toLocaleDateString('pt-BR')
                            });
                            
                            negativo.saldoRestante -= quantidadeCompensar;
                            positivo.saldoRestante -= quantidadeCompensar;
                        }
                    }
                }
            });

            console.log('Processamento de compensa√ß√µes conclu√≠do.');
        }

        // Fun√ß√£o para calcular status do lan√ßamento baseado nas regras
        function calcularStatus(lancamento) {
            // Se j√° foi quitado
            if (lancamento.quitado) {
                return { texto: 'Quitado', classe: 'badge-quitado' };
            }
            
            // Se for hora zero ou j√° foi completamente compensada
            if (lancamento.horas === 0 || lancamento.saldoRestante === 0) {
                return { texto: 'Compensada', classe: 'badge-compensada' };
            }

            // Se estiver vencida (ap√≥s 1 ano)
            if (isHoraVencida(lancamento.mes, lancamento.ano)) {
                if (lancamento.tipo === 'positiva') {
                    return { texto: 'Vencida (a receber)', classe: 'badge-warning' };
                } else {
                    return { texto: 'Vencida (a pagar)', classe: 'badge-vencida' };
                }
            }

            // Para horas n√£o vencidas, verificar proximidade do vencimento
            const dataCompetencia = dataParaObjeto(lancamento.data);
            const dataVencimento = new Date(dataCompetencia);
            dataVencimento.setFullYear(dataVencimento.getFullYear() + 1);
            
            const hoje = new Date();
            const diffTime = dataVencimento - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays <= 30) {
                return { texto: '√Ä vencer em 30 dias', classe: 'badge-warning' };
            }
            if (diffDays <= 60) {
                return { texto: '√Ä vencer em 60 dias', classe: 'badge-info' };
            }

            return { texto: 'Em dia', classe: 'badge-success' };
        }

        // Fun√ß√£o para calcular saldo acumulado por colaborador
        function calcularSaldoAcumulado(colaboradorId, lancamentosDoColaborador) {
            // Ordenar lan√ßamentos por data (mais antigos primeiro)
            const lancamentosOrdenados = [...lancamentosDoColaborador].sort((a, b) => {
                return dataParaObjeto(a.data) - dataParaObjeto(b.data);
            });

            // Calcular saldo acumulado sequencialmente usando o valor original das horas
            let saldo = 0;
            const saldosPorLancamento = [];

            for (const lanc of lancamentosOrdenados) {
                if (lanc.tipo === 'positiva') {
                    saldo += lanc.horas;
                } else {
                    saldo -= lanc.horas;
                }
                saldosPorLancamento.push({
                    id: lanc.id,
                    saldoAcumulado: saldo
                });
            }

            return saldosPorLancamento;
        }

        // Fun√ß√£o para gerar tooltip de compensa√ß√µes
        function gerarTooltipCompensacoes(lancamento) {
            let tooltip = '';
            
            // Compensa√ß√µes que este lan√ßamento fez em outros
            if (lancamento.compensacoes && lancamento.compensacoes.length > 0) {
                tooltip += 'Compensou outros lan√ßamentos:\n';
                lancamento.compensacoes.forEach(comp => {
                    const lancComp = lancamentos.find(l => l.id === comp.lancamentoId);
                    if (lancComp) {
                        const competencia = formatarCompetencia(lancComp.mes, lancComp.ano);
                        tooltip += `${competencia}: ${decimalParaHora(comp.quantidade)}\n`;
                    }
                });
            }
            
            // Lan√ßamentos que compensaram este
            if (lancamento.compensadoPor && lancamento.compensadoPor.length > 0) {
                if (tooltip) tooltip += '\n';
                tooltip += 'Foi compensado por:\n';
                lancamento.compensadoPor.forEach(comp => {
                    const lancComp = lancamentos.find(l => l.id === comp.lancamentoId);
                    if (lancComp) {
                        const competencia = formatarCompetencia(lancComp.mes, lancComp.ano);
                        tooltip += `${competencia}: ${decimalParaHora(comp.quantidade)}\n`;
                    }
                });
            }
            
            if (!tooltip) {
                tooltip = 'Nenhuma compensa√ß√£o registrada';
            }
            
            return tooltip;
        }

        // Fun√ß√£o para normalizar dados do lan√ßamento
        function normalizarLancamento(doc) {
            const data = doc.data();
            const id = doc.id;
            
            const lancamento = {
                id: id,
                colaboradorId: data.colaboradorId || data.colaborador_id || '',
                colaboradorNome: data.colaboradorNome || data.colaborador_nome || '',
                colaboradorDepartamento: data.colaboradorDepartamento || data.departamento || '',
                data: data.data || data.date || '01/01/2024',
                mes: data.mes || data.month || '01',
                ano: data.ano || data.year || '2024',
                tipo: data.tipo || data.type || 'positiva',
                horas: typeof data.horas === 'number' ? data.horas : (typeof data.hours === 'number' ? data.hours : 0),
                compensacoes: data.compensacoes || [],
                compensadoPor: data.compensadoPor || [],
                saldoRestante: data.saldoRestante !== undefined ? data.saldoRestante : (data.horas || 0),
                quitado: data.quitado || false,
                quitadoEm: data.quitadoEm || null,
                quitacaoId: data.quitacaoId || null
            };
            
            if (!lancamento.mes || !lancamento.ano) {
                const partes = lancamento.data.split('/');
                if (partes.length === 3) {
                    lancamento.mes = partes[1];
                    lancamento.ano = partes[2];
                }
            }
            
            return lancamento;
        }

        // Carregar dados do Firebase
        async function loadData() {
            if (!firebaseConnected) {
                showLoading(false);
                return;
            }
            
            showLoading(true);
            
            try {
                // Carregar empresas
                const empresasSnapshot = await db.collection('empresas').get();
                empresasDocs = empresasSnapshot.docs.map(doc => ({
                    id: doc.id,
                    nome: doc.data().nome
                }));
                empresas = empresasDocs.map(doc => doc.nome);

                // Carregar departamentos
                const departamentosSnapshot = await db.collection('departamentos').get();
                departamentosDocs = departamentosSnapshot.docs.map(doc => ({
                    id: doc.id,
                    nome: doc.data().nome
                }));
                departamentos = departamentosDocs.map(doc => doc.nome);

                // Carregar colaboradores
                const colaboradoresSnapshot = await db.collection('colaboradores').get();
                colaboradores = colaboradoresSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                colaboradores.sort((a, b) => {
                    const nomeA = (a.nome || '').toLowerCase();
                    const nomeB = (b.nome || '').toLowerCase();
                    return nomeA.localeCompare(nomeB);
                });

                // Carregar lan√ßamentos
                const lancamentosSnapshot = await db.collection('lancamentos').get();
                
                lancamentos = lancamentosSnapshot.docs.map(doc => normalizarLancamento(doc));

                // Carregar quita√ß√µes
                const quitacoesSnapshot = await db.collection('quitacoes').get();
                quitacoes = quitacoesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Ordenar quita√ß√µes por data (mais recentes primeiro)
                quitacoes.sort((a, b) => {
                    return new Date(b.dataQuitacao) - new Date(a.dataQuitacao);
                });

                // Processar compensa√ß√µes
                processarCompensacoes();

                // Ordenar lan√ßamentos por data (mais recentes primeiro)
                lancamentos.sort((a, b) => {
                    try {
                        return dataParaObjeto(b.data) - dataParaObjeto(a.data);
                    } catch (e) {
                        return 0;
                    }
                });

                updateAllTables();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Salvar compensa√ß√µes no Firebase
        async function salvarCompensacoes() {
            if (!firebaseConnected) return;
            
            try {
                for (const lanc of lancamentos) {
                    await db.collection('lancamentos').doc(lanc.id).update({
                        compensacoes: lanc.compensacoes || [],
                        compensadoPor: lanc.compensadoPor || [],
                        saldoRestante: lanc.saldoRestante !== undefined ? lanc.saldoRestante : lanc.horas
                    });
                }
            } catch (error) {
                console.error('Erro ao salvar compensa√ß√µes:', error);
            }
        }

        // Preencher anos nos selects
        function preencherAnos() {
            const anos = [];
            for (let i = 2020; i <= 2030; i++) {
                anos.push(i);
            }
            
            const selects = [
                'novoLancamentoAno',
                'filtroAno', 
                'editLancamentoAno',
                'quitacaoAnoPagamento',
                'filtroQuitacaoAno'
            ];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '';
                    if (selectId === 'filtroAno' || selectId === 'filtroQuitacaoAno') {
                        const optionAll = document.createElement('option');
                        optionAll.value = '';
                        optionAll.textContent = 'Todos';
                        select.appendChild(optionAll);
                    }
                    anos.forEach(ano => {
                        const option = document.createElement('option');
                        option.value = ano;
                        option.textContent = ano;
                        if (ano === new Date().getFullYear() && (selectId !== 'filtroAno' && selectId !== 'filtroQuitacaoAno')) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            });
        }

        // Carregar selects
        function loadSelects() {
            const deptoSelect = document.getElementById('colaboradorDepartamento');
            const empresaSelect = document.getElementById('colaboradorEmpresa');
            
            deptoSelect.innerHTML = '<option value="">Selecione...</option>';
            empresaSelect.innerHTML = '<option value="">Selecione...</option>';
            
            departamentos.sort().forEach(depto => {
                deptoSelect.innerHTML += `<option value="${depto}">${depto}</option>`;
            });
            
            empresas.sort().forEach(empresa => {
                empresaSelect.innerHTML += `<option value="${empresa}">${empresa}</option>`;
            });
        }

        function carregarFiltros() {
            const filtroColab = document.getElementById('filtroColaborador');
            filtroColab.innerHTML = '<option value="">Todos os colaboradores</option>';
            
            colaboradores.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(colab => {
                const status = colab.ativo !== false ? '' : ' (Inativo)';
                const optionText = `${colab.nome}${status}`;
                filtroColab.innerHTML += `<option value="${colab.id}">${optionText}</option>`;
            });

            const filtroDepto = document.getElementById('filtroDepartamento');
            filtroDepto.innerHTML = '<option value="">Todos os departamentos</option>';
            const deptosUnicos = [...new Set(colaboradores.map(c => c.departamento))];
            deptosUnicos.sort().forEach(depto => {
                filtroDepto.innerHTML += `<option value="${depto}">${depto}</option>`;
            });

            preencherAnos();
        }

        function carregarFiltrosQuitacoes() {
            const filtroColab = document.getElementById('filtroQuitacaoColaborador');
            filtroColab.innerHTML = '<option value="">Todos os colaboradores</option>';
            
            colaboradores.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(colab => {
                const status = colab.ativo !== false ? '' : ' (Inativo)';
                const optionText = `${colab.nome}${status}`;
                filtroColab.innerHTML += `<option value="${colab.id}">${optionText}</option>`;
            });

            const filtroDepto = document.getElementById('filtroQuitacaoDepartamento');
            filtroDepto.innerHTML = '<option value="">Todos os departamentos</option>';
            const deptosUnicos = [...new Set(colaboradores.map(c => c.departamento))];
            deptosUnicos.sort().forEach(depto => {
                filtroDepto.innerHTML += `<option value="${depto}">${depto}</option>`;
            });

            preencherAnos();
        }

        // Fun√ß√£o para aplicar filtros nas quita√ß√µes
        function aplicarFiltrosQuitacoes() {
            const colaboradorId = document.getElementById('filtroQuitacaoColaborador').value;
            const departamento = document.getElementById('filtroQuitacaoDepartamento').value;
            const status = document.getElementById('filtroQuitacaoStatus').value;
            const mes = document.getElementById('filtroQuitacaoMes').value;
            const ano = document.getElementById('filtroQuitacaoAno').value;

            let quitacoesFiltradas = [...quitacoes];

            if (colaboradorId) {
                quitacoesFiltradas = quitacoesFiltradas.filter(q => q.colaboradorId === colaboradorId);
            }

            if (departamento) {
                quitacoesFiltradas = quitacoesFiltradas.filter(q => q.colaboradorDepartamento === departamento);
            }

            if (status === 'quitadas') {
                // J√° s√£o todas quitadas
            } else if (status === 'vencidas') {
                // Mostrar apenas horas vencidas n√£o quitadas (ser√° mostrado em outra tabela)
                renderizarHorasVencidas();
                return;
            }

            if (mes) {
                quitacoesFiltradas = quitacoesFiltradas.filter(q => q.mesPagamento === mes);
            }

            if (ano) {
                quitacoesFiltradas = quitacoesFiltradas.filter(q => q.anoPagamento === ano);
            }

            document.getElementById('contadorQuitacoes').textContent = `${quitacoesFiltradas.length} quita√ß√µes`;

            renderizarTabelaQuitacoes(quitacoesFiltradas);
            renderizarHorasVencidas();
        }

        // Fun√ß√£o para limpar filtros de quita√ß√µes
        function limparFiltrosQuitacoes() {
            document.getElementById('filtroQuitacaoColaborador').value = '';
            document.getElementById('filtroQuitacaoDepartamento').value = '';
            document.getElementById('filtroQuitacaoStatus').value = 'todas';
            document.getElementById('filtroQuitacaoMes').value = '';
            document.getElementById('filtroQuitacaoAno').value = '';
            aplicarFiltrosQuitacoes();
        }

        // Fun√ß√£o para renderizar tabela de quita√ß√µes
        function renderizarTabelaQuitacoes(quitacoesFiltradas) {
            const tbody = document.getElementById('quitacoesList');
            const tabela = document.getElementById('quitacoesTable');
            const semResultados = document.getElementById('semQuitacoesMsg');

            if (quitacoesFiltradas.length === 0) {
                tabela.style.display = 'none';
                semResultados.style.display = 'block';
                return;
            }

            tabela.style.display = 'table';
            semResultados.style.display = 'none';

            tbody.innerHTML = '';

            quitacoesFiltradas.forEach(quitacao => {
                const colaborador = colaboradores.find(c => c.id === quitacao.colaboradorId);
                const dataQuitacaoFormatada = new Date(quitacao.dataQuitacao).toLocaleDateString('pt-BR');
                
                // Determinar se a quita√ß√£o foi de horas positivas ou negativas
                const tipos = [...new Set(quitacao.lancamentos.map(l => l.tipo))];
                const tipoLabel = tipos.includes('positiva') && tipos.includes('negativa') ? 'Misto' :
                                 tipos.includes('positiva') ? '‚ûï A Receber' : '‚ûñ A Pagar';
                
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${quitacao.colaboradorNome}</strong><br><small style="color: #64748b;">${quitacao.colaboradorDepartamento || ''}</small></td>
                        <td>${dataQuitacaoFormatada}</td>
                        <td>${quitacao.competenciaPagamento}</td>
                        <td><span class="badge ${tipos.includes('positiva') ? 'badge-warning' : 'badge-danger'}">${tipoLabel}</span></td>
                        <td>${decimalParaHora(quitacao.horasQuitadas)}</td>
                        <td>R$ ${quitacao.valorFolha.toFixed(2).replace('.', ',')}</td>
                        <td>R$ ${quitacao.valorReflexo.toFixed(2).replace('.', ',')}</td>
                        <td><strong>R$ ${quitacao.totalPago.toFixed(2).replace('.', ',')}</strong></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-info btn-small" onclick="showVisualizarQuitacaoModal('${quitacao.id}')" title="Ver detalhes">üîç</button>
                                <button class="btn btn-danger btn-small" onclick="deleteQuitacao('${quitacao.id}')" title="Excluir">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // Fun√ß√µes CRUD
        async function saveEmpresa() {
            const id = document.getElementById('empresaId').value;
            const nome = document.getElementById('empresaNome').value.trim();
            const nomeOriginal = document.getElementById('empresaNomeOriginal').value;

            if (!nome) {
                alert('Digite um nome para a empresa');
                return;
            }

            if ((!id || nome !== nomeOriginal) && empresas.includes(nome)) {
                alert('Esta empresa j√° est√° cadastrada!');
                return;
            }

            showLoading(true);
            try {
                if (id) {
                    await db.collection('empresas').doc(id).update({ 
                        nome,
                        updatedAt: new Date().toISOString()
                    });
                    
                    if (nome !== nomeOriginal) {
                        const colaboradoresEmpresa = colaboradores.filter(c => c.empresa === nomeOriginal);
                        for (const colab of colaboradoresEmpresa) {
                            await db.collection('colaboradores').doc(colab.id).update({
                                empresa: nome,
                                updatedAt: new Date().toISOString()
                            });
                        }
                    }
                } else {
                    await db.collection('empresas').add({ 
                        nome,
                        createdAt: new Date().toISOString()
                    });
                }
                
                await loadData();
                hideModal('empresaModal');
            } catch (error) {
                console.error('Erro ao salvar empresa:', error);
                alert('Erro ao salvar: ' + error.message);
            }
            showLoading(false);
        }

        async function saveDepartamento() {
            const id = document.getElementById('departamentoId').value;
            const nome = document.getElementById('departamentoNome').value.trim();
            const nomeOriginal = document.getElementById('departamentoNomeOriginal').value;

            if (!nome) {
                alert('Digite um nome para o departamento');
                return;
            }

            if ((!id || nome !== nomeOriginal) && departamentos.includes(nome)) {
                alert('Este departamento j√° est√° cadastrado!');
                return;
            }

            showLoading(true);
            try {
                if (id) {
                    await db.collection('departamentos').doc(id).update({ 
                        nome,
                        updatedAt: new Date().toISOString()
                    });
                    
                    if (nome !== nomeOriginal) {
                        const colaboradoresDepto = colaboradores.filter(c => c.departamento === nomeOriginal);
                        for (const colab of colaboradoresDepto) {
                            await db.collection('colaboradores').doc(colab.id).update({
                                departamento: nome,
                                updatedAt: new Date().toISOString()
                            });
                        }
                    }
                } else {
                    await db.collection('departamentos').add({ 
                        nome,
                        createdAt: new Date().toISOString()
                    });
                }
                
                await loadData();
                hideModal('departamentoModal');
            } catch (error) {
                console.error('Erro ao salvar departamento:', error);
                alert('Erro ao salvar: ' + error.message);
            }
            showLoading(false);
        }

        async function saveColaborador() {
            const id = document.getElementById('colaboradorId').value;
            const nome = document.getElementById('colaboradorNome').value.trim();
            const data = document.getElementById('colaboradorData').value;
            const departamento = document.getElementById('colaboradorDepartamento').value;
            const empresa = document.getElementById('colaboradorEmpresa').value;
            const ativo = document.getElementById('colaboradorAtivo').checked;

            if (!nome || !data || !departamento || !empresa) {
                alert('Preencha todos os campos!');
                return;
            }

            if (!isValidDate(data)) {
                alert('Data inv√°lida! Use o formato DD/MM/AAAA');
                return;
            }

            showLoading(true);
            try {
                const colaboradorData = {
                    nome,
                    dataAdmissao: data,
                    departamento,
                    empresa,
                    horasPositivas: 0,
                    horasNegativas: 0,
                    ativo: ativo,
                    updatedAt: new Date().toISOString()
                };

                if (id) {
                    await db.collection('colaboradores').doc(id).update(colaboradorData);
                } else {
                    colaboradorData.createdAt = new Date().toISOString();
                    await db.collection('colaboradores').add(colaboradorData);
                }

                await loadData();
                hideModal('colaboradorModal');
            } catch (error) {
                console.error('Erro ao salvar colaborador:', error);
                alert('Erro ao salvar: ' + error.message);
            }
            showLoading(false);
        }

        async function updateLancamento() {
            const id = document.getElementById('editLancamentoId').value;
            const colaboradorId = document.getElementById('editLancamentoColaborador').value;
            const tipo = document.getElementById('editLancamentoTipo').value;
            const horaStr = document.getElementById('editLancamentoHoras').value;
            const mes = document.getElementById('editLancamentoMes').value;
            const ano = document.getElementById('editLancamentoAno').value;

            if (!colaboradorId || !tipo || !horaStr || !mes || !ano) {
                alert('Preencha todos os campos!');
                return;
            }

            if (!isValidHora(horaStr)) {
                alert('Formato de hora inv√°lido!');
                return;
            }

            const horas = horaParaDecimal(horaStr);
            if (horas < 0) {
                alert('A quantidade de horas n√£o pode ser negativa!');
                return;
            }

            const colaborador = colaboradores.find(c => c.id === colaboradorId);
            if (!colaborador) {
                alert('Colaborador n√£o encontrado!');
                return;
            }

            const data = `01/${mes}/${ano}`;

            showLoading(true);
            try {
                await db.collection('lancamentos').doc(id).update({
                    colaboradorId: colaboradorId,
                    colaboradorNome: colaborador.nome || '',
                    colaboradorDepartamento: colaborador.departamento || '',
                    data: data,
                    mes: mes,
                    ano: ano,
                    tipo: tipo,
                    horas: horas,
                    saldoRestante: horas,
                    compensacoes: [],
                    compensadoPor: [],
                    updatedAt: new Date().toISOString()
                });

                await loadData();
                hideModal('editLancamentoModal');
                aplicarFiltros();
                alert('Lan√ßamento atualizado com sucesso!');
            } catch (error) {
                console.error('Erro ao atualizar:', error);
                alert('Erro ao atualizar: ' + error.message);
            }
            showLoading(false);
        }

        async function deleteLancamento(id) {
            if (!confirm('Tem certeza que deseja excluir este lan√ßamento?')) return;

            showLoading(true);
            try {
                await db.collection('lancamentos').doc(id).delete();
                await loadData();
                aplicarFiltros();
                alert('Lan√ßamento exclu√≠do com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir:', error);
                alert('Erro ao excluir: ' + error.message);
            }
            showLoading(false);
        }

        async function importColaboradores() {
            const data = document.getElementById('importData').value;
            const lines = data.split('\n');
            let imported = 0;
            let errors = 0;

            showLoading(true);
            try {
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const [nome, dataAdmissao, departamento, empresa] = line.split(',').map(item => item.trim());
                        
                        if (nome && dataAdmissao && departamento && empresa) {
                            if (!departamentos.includes(departamento)) {
                                errors++;
                                continue;
                            }
                            
                            if (!empresas.includes(empresa)) {
                                errors++;
                                continue;
                            }
                            
                            if (isValidDate(dataAdmissao)) {
                                await db.collection('colaboradores').add({
                                    nome,
                                    dataAdmissao,
                                    departamento,
                                    empresa,
                                    horasPositivas: 0,
                                    horasNegativas: 0,
                                    ativo: true,
                                    createdAt: new Date().toISOString()
                                });
                                imported++;
                            } else {
                                errors++;
                            }
                        } else {
                            errors++;
                        }
                    }
                }

                await loadData();
                alert(`${imported} colaborador(es) importado(s) com sucesso! ${errors} erro(s).`);
                hideModal('importModal');
            } catch (error) {
                console.error('Erro ao importar:', error);
                alert('Erro ao importar: ' + error.message);
            }
            showLoading(false);
        }

        // Fun√ß√£o para aplicar filtros
        function aplicarFiltros() {
            const colaboradorId = document.getElementById('filtroColaborador').value;
            const departamento = document.getElementById('filtroDepartamento').value;
            const status = document.getElementById('filtroStatus').value;
            const mes = document.getElementById('filtroMes').value;
            const ano = document.getElementById('filtroAno').value;

            let lancamentosFiltrados = [...lancamentos];

            if (colaboradorId) {
                lancamentosFiltrados = lancamentosFiltrados.filter(l => l.colaboradorId === colaboradorId);
            }

            if (departamento) {
                lancamentosFiltrados = lancamentosFiltrados.filter(l => l.colaboradorDepartamento === departamento);
            }

            if (status !== 'todos') {
                const statusAtivo = status === 'ativos';
                lancamentosFiltrados = lancamentosFiltrados.filter(l => {
                    const colaborador = colaboradores.find(c => c.id === l.colaboradorId);
                    const colaboradorAtivo = colaborador ? colaborador.ativo !== false : true;
                    return colaboradorAtivo === statusAtivo;
                });
            }

            if (mes) {
                lancamentosFiltrados = lancamentosFiltrados.filter(l => l.mes === mes);
            }
            if (ano) {
                lancamentosFiltrados = lancamentosFiltrados.filter(l => l.ano === ano);
            }

            document.getElementById('contadorLancamentos').textContent = `${lancamentosFiltrados.length} lan√ßamentos`;

            const resumoContainer = document.getElementById('resumoSaldoContainer');
            if (colaboradorId) {
                const colaborador = colaboradores.find(c => c.id === colaboradorId);
                if (colaborador) {
                    document.getElementById('resumoColaboradorNome').textContent = colaborador.nome;
                    
                    // Calcular saldo total (usando horas originais)
                    const saldoTotal = lancamentos
                        .filter(l => l.colaboradorId === colaboradorId)
                        .reduce((sum, l) => {
                            return l.tipo === 'positiva' ? sum + l.horas : sum - l.horas;
                        }, 0);
                    
                    document.getElementById('resumoSaldoTotal').textContent = decimalParaHora(saldoTotal);
                    
                    resumoContainer.style.display = 'flex';
                }
            } else {
                resumoContainer.style.display = 'none';
            }

            renderizarTabelaLancamentos(lancamentosFiltrados);
        }

        // Fun√ß√£o para renderizar tabela de lan√ßamentos
        function renderizarTabelaLancamentos(lancamentosFiltrados) {
            const tbody = document.getElementById('lancamentosList');
            const tabela = document.getElementById('lancamentosTable');
            const semResultados = document.getElementById('semResultadosMsg');

            if (lancamentosFiltrados.length === 0) {
                tabela.style.display = 'none';
                semResultados.style.display = 'block';
                return;
            }

            tabela.style.display = 'table';
            semResultados.style.display = 'none';

            tbody.innerHTML = '';

            // Agrupar lan√ßamentos por colaborador para calcular saldo acumulado
            const lancamentosPorColaborador = {};
            lancamentosFiltrados.forEach(lanc => {
                if (!lancamentosPorColaborador[lanc.colaboradorId]) {
                    lancamentosPorColaborador[lanc.colaboradorId] = [];
                }
                lancamentosPorColaborador[lanc.colaboradorId].push(lanc);
            });

            // Calcular saldo acumulado para cada colaborador (usando horas originais)
            const saldosAcumulados = {};
            Object.keys(lancamentosPorColaborador).forEach(colaboradorId => {
                const lancamentosColab = lancamentosPorColaborador[colaboradorId];
                const saldos = calcularSaldoAcumulado(colaboradorId, lancamentosColab);
                saldosAcumulados[colaboradorId] = new Map(saldos.map(s => [s.id, s.saldoAcumulado]));
            });

            lancamentosFiltrados.forEach(lanc => {
                const colaborador = colaboradores.find(c => c.id === lanc.colaboradorId);
                if (!colaborador) return;

                const competencia = formatarCompetencia(lanc.mes, lanc.ano);
                const vencimento = calcularVencimento(lanc.mes, lanc.ano);
                const status = calcularStatus(lanc);
                
                const quantidadeIcon = lanc.tipo === 'positiva' ? '‚ûï' : '‚ûñ';
                
                // Obter saldo acumulado para este lan√ßamento
                const saldoAcumulado = saldosAcumulados[lanc.colaboradorId]?.get(lanc.id) || 0;
                
                // Horas que faltam compensar
                const horasFaltantes = lanc.saldoRestante !== undefined ? lanc.saldoRestante : lanc.horas;
                
                // Gerar tooltip com as compensa√ß√µes
                const tooltipText = gerarTooltipCompensacoes(lanc);
                
                const compensacoesText = horasFaltantes > 0 ? 
                    `<span class="badge badge-warning compensacoes-tooltip" data-tooltip="${tooltipText}">Falta ${decimalParaHora(horasFaltantes)}</span>` : 
                    `<span class="badge badge-success compensacoes-tooltip" data-tooltip="${tooltipText}">Completo</span>`;

                // Bot√£o de visualizar compensa√ß√µes
                const visualizarBtn = (lanc.compensacoes && lanc.compensacoes.length > 0) || (lanc.compensadoPor && lanc.compensadoPor.length > 0) ?
                    `<button class="btn btn-info btn-small" onclick="showVisualizarCompensacoesModal('${lanc.id}')" title="Ver detalhes das compensa√ß√µes">üîç</button>` : '';

                // Bot√£o de quitar (aparece apenas para horas vencidas - AMBOS OS TIPOS)
                const quitarBtn = (!lanc.quitado && horasFaltantes > 0 && isHoraVencida(lanc.mes, lanc.ano)) ?
                    `<button class="btn btn-primary btn-small" onclick="showNovaQuitacaoParaColaborador('${lanc.colaboradorId}')" title="Quitar horas vencidas">üí∞</button>` : '';

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${colaborador.nome}</strong><br><small style="color: #64748b;">${colaborador.departamento}</small></td>
                        <td><span class="badge ${lanc.tipo === 'positiva' ? 'badge-success' : 'badge-danger'}">${quantidadeIcon} ${decimalParaHora(lanc.horas)}</span></td>
                        <td>${competencia}</td>
                        <td>${vencimento}</td>
                        <td><span class="badge ${status.classe}">${status.texto}</span></td>
                        <td><span class="badge ${saldoAcumulado >= 0 ? 'badge-success' : 'badge-danger'}">${decimalParaHora(saldoAcumulado)}</span></td>
                        <td>${compensacoesText}</td>
                        <td>
                            <div class="action-buttons">
                                ${visualizarBtn}
                                ${quitarBtn}
                                <button class="btn btn-warning btn-small" onclick="showEditLancamentoModal('${lanc.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-small" onclick="deleteLancamento('${lanc.id}')">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // Fun√ß√µes de filtro para colaboradores
        function filterColaboradores() {
            const searchTerm = document.getElementById('searchColaborador').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const deptoFilter = document.getElementById('filterDepartamento').value;
            const empresaFilter = document.getElementById('filterEmpresa').value;

            colaboradoresFiltrados = colaboradores.filter(colab => {
                const matchSearch = colab.nome.toLowerCase().includes(searchTerm) ||
                                  colab.departamento.toLowerCase().includes(searchTerm) ||
                                  colab.empresa.toLowerCase().includes(searchTerm);
                const matchDepto = !deptoFilter || colab.departamento === deptoFilter;
                const matchEmpresa = !empresaFilter || colab.empresa === empresaFilter;
                
                let matchStatus = true;
                if (statusFilter === 'ativos') {
                    matchStatus = colab.ativo !== false;
                } else if (statusFilter === 'inativos') {
                    matchStatus = colab.ativo === false;
                }
                
                return matchSearch && matchDepto && matchEmpresa && matchStatus;
            });

            colaboradoresFiltrados.sort((a, b) => {
                const nomeA = (a.nome || '').toLowerCase();
                const nomeB = (b.nome || '').toLowerCase();
                return nomeA.localeCompare(nomeB);
            });

            sortField = 'nome';
            sortDirection = 'asc';
            currentPage = 1;
            updateColaboradoresTable();
        }

        function sortColaboradores(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }

            colaboradoresFiltrados.sort((a, b) => {
                let valA = a[field];
                let valB = b[field];
                
                if (field === 'dataAdmissao') {
                    const [dA, mA, yA] = valA.split('/');
                    const [dB, mB, yB] = valB.split('/');
                    valA = new Date(yA, mA - 1, dA);
                    valB = new Date(yB, mB - 1, dB);
                } else {
                    valA = String(valA || '').toLowerCase();
                    valB = String(valB || '').toLowerCase();
                }
                
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            updateColaboradoresTable();
        }

        function updateColaboradoresTable() {
            const tbody = document.getElementById('colaboradoresList');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedColabs = colaboradoresFiltrados.slice(start, end);

            tbody.innerHTML = '';

            if (colaboradoresFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">Nenhum colaborador encontrado.</td></tr>';
                updatePagination();
                return;
            }

            paginatedColabs.forEach(colab => {
                const lancamentosColab = lancamentos.filter(l => l.colaboradorId === colab.id);
                // Calcular saldo total usando horas originais
                const saldoTotal = lancamentosColab.reduce((sum, l) => {
                    return l.tipo === 'positiva' ? sum + l.horas : sum - l.horas;
                }, 0);
                
                const statusClass = saldoTotal >= 0 ? 'badge-success' : 'badge-danger';
                const statusText = colab.ativo !== false ? 
                    '<span class="badge badge-success">Ativo</span>' : 
                    '<span class="badge badge-danger">Inativo</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${colab.nome}</td>
                        <td>${colab.dataAdmissao}</td>
                        <td>${colab.departamento}</td>
                        <td>${colab.empresa}</td>
                        <td><span class="badge ${statusClass}">${decimalParaHora(saldoTotal)}</span></td>
                        <td>${statusText}</td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="showColaboradorModal('${colab.id}')">Editar</button>
                            <button class="btn btn-danger btn-small" onclick="deleteColaborador('${colab.id}')">Excluir</button>
                        </td>
                    </tr>
                `;
            });

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(colaboradoresFiltrados.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'}" style="padding: 8px 12px;" onclick="goToPage(${i})">${i}</button>`;
            }
            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            updateColaboradoresTable();
        }

        async function deleteColaborador(id) {
            const colaborador = colaboradores.find(c => c.id === id);
            if (!colaborador) return;

            if (confirm(`Excluir "${colaborador.nome}"?`)) {
                showLoading(true);
                try {
                    const lancamentosRelacionados = lancamentos.filter(l => l.colaboradorId === id);
                    for (const lanc of lancamentosRelacionados) {
                        await db.collection('lancamentos').doc(lanc.id).delete();
                    }
                    
                    await db.collection('colaboradores').doc(id).delete();
                    await loadData();
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    alert('Erro ao deletar: ' + error.message);
                }
                showLoading(false);
            }
        }

        async function deleteEmpresa(nome) {
            const colaboradoresNaEmpresa = colaboradores.filter(c => c.empresa === nome);
            if (colaboradoresNaEmpresa.length > 0) {
                alert(`Existem ${colaboradoresNaEmpresa.length} colaborador(es) vinculados.`);
                return;
            }

            if (confirm(`Excluir empresa "${nome}"?`)) {
                showLoading(true);
                try {
                    const empresaDoc = empresasDocs.find(doc => doc.nome === nome);
                    if (empresaDoc) {
                        await db.collection('empresas').doc(empresaDoc.id).delete();
                        await loadData();
                    }
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    alert('Erro ao deletar: ' + error.message);
                }
                showLoading(false);
            }
        }

        async function deleteDepartamento(nome) {
            const colaboradoresNoDepto = colaboradores.filter(c => c.departamento === nome);
            if (colaboradoresNoDepto.length > 0) {
                alert(`Existem ${colaboradoresNoDepto.length} colaborador(es) vinculados.`);
                return;
            }

            if (confirm(`Excluir departamento "${nome}"?`)) {
                showLoading(true);
                try {
                    const deptoDoc = departamentosDocs.find(doc => doc.nome === nome);
                    if (deptoDoc) {
                        await db.collection('departamentos').doc(deptoDoc.id).delete();
                        await loadData();
                    }
                } catch (error) {
                    console.error('Erro ao deletar:', error);
                    alert('Erro ao deletar: ' + error.message);
                }
                showLoading(false);
            }
        }

        function updateEmpresasTable() {
            const tbody = document.getElementById('empresasList');
            const alert = document.getElementById('empresasAlert');
            
            tbody.innerHTML = '';

            if (empresas.length === 0) {
                alert.classList.remove('hidden');
                return;
            }

            alert.classList.add('hidden');
            empresas.sort().forEach(empresa => {
                tbody.innerHTML += `
                    <tr>
                        <td>${empresa}</td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="showEmpresaModal('${empresa}')">Editar</button>
                            <button class="btn btn-danger btn-small" onclick="deleteEmpresa('${empresa}')">Excluir</button>
                        </td>
                    </tr>
                `;
            });
        }

        function updateDepartamentosTable() {
            const tbody = document.getElementById('departamentosList');
            const alert = document.getElementById('departamentosAlert');
            
            tbody.innerHTML = '';

            if (departamentos.length === 0) {
                alert.classList.remove('hidden');
                return;
            }

            alert.classList.add('hidden');
            departamentos.sort().forEach(depto => {
                tbody.innerHTML += `
                    <tr>
                        <td>${depto}</td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="showDepartamentoModal('${depto}')">Editar</button>
                            <button class="btn btn-danger btn-small" onclick="deleteDepartamento('${depto}')">Excluir</button>
                        </td>
                    </tr>
                `;
            });
        }

        function updateDashboard() {
            document.getElementById('totalColaboradores').textContent = colaboradores.filter(c => c.ativo !== false).length;
            
            let totalPositivas = lancamentos
                .filter(l => l.tipo === 'positiva')
                .reduce((sum, l) => sum + l.horas, 0);
            let totalNegativas = lancamentos
                .filter(l => l.tipo === 'negativa')
                .reduce((sum, l) => sum + l.horas, 0);
            
            document.getElementById('totalHorasPositivas').textContent = decimalParaHora(totalPositivas);
            document.getElementById('totalHorasNegativas').textContent = decimalParaHora(totalNegativas);
            document.getElementById('saldoLiquido').textContent = decimalParaHora(totalPositivas - totalNegativas);

            const activities = document.getElementById('recentActivities');
            
            if (lancamentos.length === 0) {
                activities.innerHTML = '<div style="text-align: center; padding: 20px;">Nenhum lan√ßamento recente</div>';
                return;
            }

            activities.innerHTML = lancamentos.slice(0, 5).map(lanc => {
                const colaborador = colaboradores.find(c => c.id === lanc.colaboradorId);
                if (!colaborador) return '';
                
                const tipoClass = lanc.tipo === 'positiva' ? 'badge-success' : 'badge-danger';
                const tipoIcon = lanc.tipo === 'positiva' ? '‚ûï' : '‚ûñ';
                const status = calcularStatus(lanc);
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f1f5f9;">
                        <div>
                            <strong>${colaborador.nome}</strong>
                            <span class="badge ${tipoClass}" style="margin-left: 8px;">${tipoIcon} ${decimalParaHora(lanc.horas)}</span>
                            <span class="badge ${status.classe}" style="margin-left: 8px;">${status.texto}</span>
                        </div>
                        <span style="color: #64748b;">${lanc.data}</span>
                    </div>
                `;
            }).join('');
        }

        function updateAllTables() {
            updateEmpresasTable();
            updateDepartamentosTable();
            updateDashboard();
            carregarFiltros();
            carregarFiltrosQuitacoes();
            aplicarFiltros();
            aplicarFiltrosQuitacoes();
            filterColaboradores();
            renderizarHorasVencidas();
            
            // Salvar compensa√ß√µes no Firebase
            salvarCompensacoes();
        }

        // Fechar modais ao clicar fora
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            preencherAnos();
            document.getElementById('quitacaoData').value = new Date().toISOString().split('T')[0];
            showTab('dashboard');
        });
    </script>
</body>
</html>